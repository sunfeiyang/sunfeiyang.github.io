{"title":"MySQL慢查询","num_read":248,"num_like":47,"num_collection":210,"num_comments":134,"slug":"resource-DB-MySQL-MySQL-slowQuery","date":"2021-10-19T16:00:00.000Z","img":"/img/header_img/DB/slowQuery.png","_id":"clhrbp2aw001wo5lg139w5g1t","project":"DB","type":"banner","subtitle":"由long_query_time执行时间超过几秒钟并且至少min_examined_row_limit需要检查行的SQL语句组成","site":{"data":{}},"updated":"2021-11-06T08:52:46.000Z","author":"Sunfy","comments":true,"path":"api/articles/resource-DB-MySQL-MySQL-slowQuery.json","webPath":"2021/10/20/resource-DB-MySQL-MySQL-slowQuery/","permalink":"https://sunfy9.gitee.io/2021/10/20/resource-DB-MySQL-MySQL-slowQuery/","excerpt":null,"covers":null,"keywords":"sunfy, hexo-theme-snail","content":"<h1 id=\"基本概念\"><a href=\"#基本概念\" class=\"headerlink\" title=\"基本概念\"></a>基本概念</h1><p>以下基于mysql5.7版本</p>\n<p>官方说明：慢查询日志由<a href=\"https://dev.mysql.com/doc/refman/5.7/en/server-system-variables.html#sysvar_long_query_time\" target=\"_blank\" rel=\"noopener\"><code>long_query_time</code></a>执行时间超过几秒钟并且至少 <a href=\"https://dev.mysql.com/doc/refman/5.7/en/server-system-variables.html#sysvar_min_examined_row_limit\" target=\"_blank\" rel=\"noopener\"><code>min_examined_row_limit</code></a>需要检查行的 SQL 语句组成 。慢查询日志可用于查找需要很长时间执行的查询，因此可以进行优化。但是，检查长而缓慢的查询日志可能是一项耗时的任务。为了使这更容易，您可以使用 <a href=\"https://dev.mysql.com/doc/refman/5.7/en/mysqldumpslow.html\" target=\"_blank\" rel=\"noopener\"><strong>mysqldumpslow</strong></a>命令来处理慢查询日志文件并总结其内容。请参阅 <a href=\"https://dev.mysql.com/doc/refman/5.7/en/mysqldumpslow.html\" target=\"_blank\" rel=\"noopener\">第 4.6.8 节，“mysqldumpslow - 总结慢查询日志文件”</a>。</p>\n<p>获取初始锁的时间不计入执行时间。<a href=\"https://dev.mysql.com/doc/refman/5.7/en/mysqld.html\" target=\"_blank\" rel=\"noopener\"><strong>mysqld</strong></a>会在执行完所有锁后，将语句写入慢查询日志，因此日志顺序可能与执行顺序不同。</p>\n<p>MySQL的慢查询，全名是慢查询日志，是MySQL提供的一种日志记录，用来记录MySQL中响应时间超过阈值的语句。</p>\n<p>具体的环境中，运行时间超过<code>long_query_time</code>值的SQL语句，则会被记录到慢查询日志中。</p>\n<p><code>long_query_time</code>默认值为10，就是SQL查询时间超过设定值时，会记录当前SQL。</p>\n<p>MySQL默认不启动慢查询日志，非调优需要，一般不建议启动该参数，因为开启慢查询后或多或少会对性能有一些影响。</p>\n<p>MySQL（5.7）官方对慢查询的说明：<a href=\"https://dev.mysql.com/doc/refman/5.7/en/slow-query-log.html\" target=\"_blank\" rel=\"noopener\">https://dev.mysql.com/doc/refman/5.7/en/slow-query-log.html</a></p>\n<h1 id=\"日志参数\"><a href=\"#日志参数\" class=\"headerlink\" title=\"日志参数\"></a>日志参数</h1><p><strong>slow_query_log</strong> 设置<a href=\"https://dev.mysql.com/doc/refman/5.7/en/server-system-variables.html#sysvar_slow_query_log\" target=\"_blank\" rel=\"noopener\"><code>slow_query_log</code></a> 为 0 以禁用日志或设置为 1 以启用它。</p>\n<p><strong>slow_query_log_file</strong> 设置 <a href=\"https://dev.mysql.com/doc/refman/5.7/en/server-system-variables.html#sysvar_slow_query_log_file\" target=\"_blank\" rel=\"noopener\"><code>slow_query_log_file</code></a>以指定日志文件的名称</p>\n<p><strong>log_queries_not_using_indexes</strong> 要在写入慢查询日志的语句中包含不使用行查找索引的查询，请启用 <a href=\"https://dev.mysql.com/doc/refman/5.7/en/server-system-variables.html#sysvar_log_queries_not_using_indexes\" target=\"_blank\" rel=\"noopener\"><code>log_queries_not_using_indexes</code></a> 系统变量。（即使启用了该变量，服务器也不会记录由于表的行数少于两行而不会从索引的存在中受益的查询。）</p>\n<p><strong>log_throttle_queries_not_using_indexes</strong> 当记录不使用索引的查询时，慢查询日志可能会快速增长。可以通过设置<a href=\"https://dev.mysql.com/doc/refman/5.7/en/server-system-variables.html#sysvar_log_throttle_queries_not_using_indexes\" target=\"_blank\" rel=\"noopener\"><code>log_throttle_queries_not_using_indexes</code></a> 系统变量对这些查询设置速率限制 。默认情况下，此变量为 0，这意味着没有限制。正值对不使用索引的查询的日志记录施加了每分钟限制。第一个这样的查询打开一个 60 秒的窗口，在该窗口中服务器记录查询达到给定的限制，然后抑制其他查询。如果在窗口结束时有被抑制的查询，服务器会记录一个摘要，指示有多少查询以及在这些查询中花费的总时间。当服务器记录下一个不使用索引的查询时，下一个 60 秒窗口开始。</p>\n<p>服务器按照以下顺序使用控制参数来决定是否将查询写入慢查询日志：</p>\n<ul>\n<li>查询必须不是管理语句，或者 <a href=\"https://dev.mysql.com/doc/refman/5.7/en/server-system-variables.html#sysvar_log_slow_admin_statements\" target=\"_blank\" rel=\"noopener\"><code>log_slow_admin_statements</code></a> 必须启用。</li>\n<li>查询必须至少花费了 <a href=\"https://dev.mysql.com/doc/refman/5.7/en/server-system-variables.html#sysvar_long_query_time\" target=\"_blank\" rel=\"noopener\"><code>long_query_time</code></a>几秒钟，或者 <a href=\"https://dev.mysql.com/doc/refman/5.7/en/server-system-variables.html#sysvar_log_queries_not_using_indexes\" target=\"_blank\" rel=\"noopener\"><code>log_queries_not_using_indexes</code></a> 必须启用并且查询没有使用索引进行行查找。</li>\n<li>查询必须至少检查过 <a href=\"https://dev.mysql.com/doc/refman/5.7/en/server-system-variables.html#sysvar_min_examined_row_limit\" target=\"_blank\" rel=\"noopener\"><code>min_examined_row_limit</code></a> 行。</li>\n<li>不得根据<a href=\"https://dev.mysql.com/doc/refman/5.7/en/server-system-variables.html#sysvar_log_throttle_queries_not_using_indexes\" target=\"_blank\" rel=\"noopener\"><code>log_throttle_queries_not_using_indexes</code></a> 设置抑制查询 。</li>\n</ul>\n<h1 id=\"慢查询日志内容\"><a href=\"#慢查询日志内容\" class=\"headerlink\" title=\"慢查询日志内容\"></a>慢查询日志内容</h1><p>启用慢查询日志后，服务器将输出写入<a href=\"https://dev.mysql.com/doc/refman/5.7/en/server-system-variables.html#sysvar_log_output\" target=\"_blank\" rel=\"noopener\"><code>log_output</code></a>系统变量指定的任何目的地 。如果启用日志，服务器将打开日志文件并将启动消息写入其中。但是，除非<code>FILE</code>选择了日志目标，否则不会将查询进一步记录到文件中。如果目标是 <code>NONE</code>，则即使启用了慢查询日志，服务器也不会写入任何查询。如果<code>FILE</code>未选择作为输出目的地，则设置日志文件名对日志记录没有影响。</p>\n<p>如果启用慢查询日志并<code>FILE</code>选择作为输出目标，则写入日志的每个语句前面都有一行以<code>#</code>字符开头 并具有以下字段（所有字段在一行中）：</p>\n<ul>\n<li><p><code>Query_time:</code>duration</p>\n<p>语句执行时间（以秒为单位）。</p>\n</li>\n<li><p><code>Lock_time:</code>duration</p>\n<p>以秒为单位获取锁的时间。</p>\n</li>\n<li><p><code>Rows_sent:</code>N</p>\n<p>发送到客户端的行数。</p>\n</li>\n<li><p><code>Rows_examined:</code></p>\n<p>服务器层检查的行数（不包括存储引擎内部的任何处理）。</p>\n</li>\n</ul>\n<p>写入慢查询日志文件的每个语句前面都有一个<a href=\"https://dev.mysql.com/doc/refman/5.7/en/set-variable.html\" target=\"_blank\" rel=\"noopener\"><code>SET</code></a> 包含时间戳的语句，该时间戳指示记录慢语句的时间（在语句完成执行后发生）。</p>\n<p>写入慢查询日志的语句中的密码由服务器重写，不会以纯文本的形式出现。请参阅<a href=\"https://dev.mysql.com/doc/refman/5.7/en/password-logging.html\" target=\"_blank\" rel=\"noopener\">第 6.1.2.3 节，“密码和日志记录”</a>。</p>\n<h1 id=\"参数配置\"><a href=\"#参数配置\" class=\"headerlink\" title=\"参数配置\"></a>参数配置</h1><h2 id=\"slow-query-log\"><a href=\"#slow-query-log\" class=\"headerlink\" title=\"slow_query_log\"></a>slow_query_log</h2><p>使用<code>set global slow_query_log=1</code>开启了慢查询日志只对当前数据库生效，MySQL重启后则会失效。</p>\n<p>如果要永久生效，就必须修改配置文件<code>my.cnf</code>（其它系统变量也是如此）。</p>\n<p><code>my.cnf</code>要增加或修改参数<code>slow_query_log</code> 和<code>slow_query_log_file</code>，如下所示</p>\n<blockquote>\n<p>slow_query_log = 1</p>\n<p>slow_query_log_file = /tmp/mysql_slow.log</p>\n</blockquote>\n<p>然后重启MySQL服务器。</p>\n<h2 id=\"slow-query-log-file\"><a href=\"#slow-query-log-file\" class=\"headerlink\" title=\"slow_query_log_file\"></a>slow_query_log_file</h2><p>这个参数用于指定慢查询日志的存放路径，缺省情况是<code>host_name-slow.log</code>文件</p>\n<blockquote>\n<p>show variables like ‘slow_query_log_file’</p>\n</blockquote>\n<h2 id=\"long-query-time\"><a href=\"#long-query-time\" class=\"headerlink\" title=\"long_query_time\"></a>long_query_time</h2><p>mysql源码里是判断大于<code>long_query_time</code>，而非大于等于。</p>\n<p>从MySQL 5.1开始，<code>long_query_time</code>开始以<strong>微秒</strong>记录SQL语句运行时间，之前仅用秒为单位记录。</p>\n<p>如果记录到表里面，只会记录整数部分，不会记录微秒部分。</p>\n<p>注意：使用命令 set global long_query_time=4修改后，需要重新连接或新开一个会话才能看到修改值。</p>\n<p>用show variables like ‘long_query_time’查看是当前会话的变量值。</p>\n<p>也可以不用重新连接会话，而是用show global variables like ‘long_query_time’;。</p>\n<h2 id=\"log-output\"><a href=\"#log-output\" class=\"headerlink\" title=\"log_output\"></a>log_output</h2><p>log_output参数指定日志的存储方式。</p>\n<p>log_output=’FILE’表示将日志存入文件，默认值也是’FILE’。</p>\n<p>log_output=’TABLE’表示将日志存入数据库，这样日志信息就会被写入到mysql.slow_log表中。</p>\n<p>同时也支持两种日志存储方式，配置的时候以逗号隔开即可，如：log_output=’FILE,TABLE’。</p>\n<p>日志记录到系统的专用日志表中，要比记录到文件耗费更多的系统资源。</p>\n<p>因此对于需要启用慢查询日志，又需要能够获得更高的系统性能，那么建议优先记录到文件。</p>\n<blockquote>\n<p>show variables like ‘%log_output%’;</p>\n<p>set global log_output=’TABLE’;</p>\n</blockquote>\n<h2 id=\"log-queries-not-using-indexes\"><a href=\"#log-queries-not-using-indexes\" class=\"headerlink\" title=\"log-queries-not-using-indexes\"></a>log-queries-not-using-indexes</h2><p>该系统变量指定<strong>未使用索引的查询</strong>也被记录到慢查询日志中（可选项）。</p>\n<p>如果调优的话，建议开启这个选项。</p>\n<p>另外，开启了这个参数，其实使用<code>full index scan</code>的SQL也会被记录到慢查询日志。</p>\n<blockquote>\n<p>show variables like ‘log_queries_not_using_indexes’;</p>\n<p>set global log_queries_not_using_indexes=1;</p>\n</blockquote>\n<h2 id=\"log-slow-admin-statements\"><a href=\"#log-slow-admin-statements\" class=\"headerlink\" title=\"log_slow_admin_statements\"></a>log_slow_admin_statements</h2><p>这个系统变量表示，是否将慢管理语句例如<code>ANALYZE TABLE</code>和<code>ALTER TABLE</code>等记入慢查询日志。</p>\n<blockquote>\n<p>show variables like ‘log_slow_admin_statements’;</p>\n</blockquote>\n<h2 id=\"Slow-queries\"><a href=\"#Slow-queries\" class=\"headerlink\" title=\"Slow_queries\"></a>Slow_queries</h2><p>如果你想查询有多少条慢查询记录，可以使用<code>Slow_queries</code>系统变量。</p>\n<blockquote>\n<p>show global status like ‘%Slow_queries%’;</p>\n</blockquote>\n<p>另外，还有<code>log_slow_slave_statements</code> 和<code>--log-short-format</code> 参数，可到MySQL网站了解。</p>\n<h1 id=\"mysqldumpslow\"><a href=\"#mysqldumpslow\" class=\"headerlink\" title=\"mysqldumpslow\"></a>mysqldumpslow</h1><p>慢查询日志分析工具<br>mysqldumpslow经常使用的参数：<br>-s，是order的顺序<br>——-al 平均锁定时间<br>——-ar 平均返回记录时间<br>——-at 平均查询时间（默认）<br>——-c 计数<br>——-l 锁定时间<br>——-r 返回记录<br>——-t 查询时间<br>-t，是top n的意思，即为返回前面多少条的数据<br>-g，后边可以写一个正则匹配模式，大小写不敏感的</p>\n<p>比如，得到返回记录集最多的10个SQL。</p>\n<blockquote>\n<p>mysqldumpslow -s r -t 10 /database/mysql/mysql06_slow.log</p>\n</blockquote>\n<p>得到访问次数最多的10个SQL</p>\n<blockquote>\n<p>mysqldumpslow -s c -t 10 /database/mysql/mysql06_slow.log</p>\n</blockquote>\n<p>得到按照时间排序的前10条里面含有左连接的查询语句。</p>\n<blockquote>\n<p>mysqldumpslow -s t -t 10 -g “left join” /database/mysql/mysql06_slow.log</p>\n</blockquote>\n<p>另外建议在使用这些命令时结合 | 和more 使用 ，否则有可能出现刷屏的情况。</p>\n<blockquote>\n<p>mysqldumpslow -s r -t 20 /mysqldata/mysql/mysql06-slow.log | more</p>\n</blockquote>\n","more":"<h1 id=\"基本概念\"><a href=\"#基本概念\" class=\"headerlink\" title=\"基本概念\"></a>基本概念</h1><p>以下基于mysql5.7版本</p>\n<p>官方说明：慢查询日志由<a href=\"https://dev.mysql.com/doc/refman/5.7/en/server-system-variables.html#sysvar_long_query_time\" target=\"_blank\" rel=\"noopener\"><code>long_query_time</code></a>执行时间超过几秒钟并且至少 <a href=\"https://dev.mysql.com/doc/refman/5.7/en/server-system-variables.html#sysvar_min_examined_row_limit\" target=\"_blank\" rel=\"noopener\"><code>min_examined_row_limit</code></a>需要检查行的 SQL 语句组成 。慢查询日志可用于查找需要很长时间执行的查询，因此可以进行优化。但是，检查长而缓慢的查询日志可能是一项耗时的任务。为了使这更容易，您可以使用 <a href=\"https://dev.mysql.com/doc/refman/5.7/en/mysqldumpslow.html\" target=\"_blank\" rel=\"noopener\"><strong>mysqldumpslow</strong></a>命令来处理慢查询日志文件并总结其内容。请参阅 <a href=\"https://dev.mysql.com/doc/refman/5.7/en/mysqldumpslow.html\" target=\"_blank\" rel=\"noopener\">第 4.6.8 节，“mysqldumpslow - 总结慢查询日志文件”</a>。</p>\n<p>获取初始锁的时间不计入执行时间。<a href=\"https://dev.mysql.com/doc/refman/5.7/en/mysqld.html\" target=\"_blank\" rel=\"noopener\"><strong>mysqld</strong></a>会在执行完所有锁后，将语句写入慢查询日志，因此日志顺序可能与执行顺序不同。</p>\n<p>MySQL的慢查询，全名是慢查询日志，是MySQL提供的一种日志记录，用来记录MySQL中响应时间超过阈值的语句。</p>\n<p>具体的环境中，运行时间超过<code>long_query_time</code>值的SQL语句，则会被记录到慢查询日志中。</p>\n<p><code>long_query_time</code>默认值为10，就是SQL查询时间超过设定值时，会记录当前SQL。</p>\n<p>MySQL默认不启动慢查询日志，非调优需要，一般不建议启动该参数，因为开启慢查询后或多或少会对性能有一些影响。</p>\n<p>MySQL（5.7）官方对慢查询的说明：<a href=\"https://dev.mysql.com/doc/refman/5.7/en/slow-query-log.html\" target=\"_blank\" rel=\"noopener\">https://dev.mysql.com/doc/refman/5.7/en/slow-query-log.html</a></p>\n<h1 id=\"日志参数\"><a href=\"#日志参数\" class=\"headerlink\" title=\"日志参数\"></a>日志参数</h1><p><strong>slow_query_log</strong> 设置<a href=\"https://dev.mysql.com/doc/refman/5.7/en/server-system-variables.html#sysvar_slow_query_log\" target=\"_blank\" rel=\"noopener\"><code>slow_query_log</code></a> 为 0 以禁用日志或设置为 1 以启用它。</p>\n<p><strong>slow_query_log_file</strong> 设置 <a href=\"https://dev.mysql.com/doc/refman/5.7/en/server-system-variables.html#sysvar_slow_query_log_file\" target=\"_blank\" rel=\"noopener\"><code>slow_query_log_file</code></a>以指定日志文件的名称</p>\n<p><strong>log_queries_not_using_indexes</strong> 要在写入慢查询日志的语句中包含不使用行查找索引的查询，请启用 <a href=\"https://dev.mysql.com/doc/refman/5.7/en/server-system-variables.html#sysvar_log_queries_not_using_indexes\" target=\"_blank\" rel=\"noopener\"><code>log_queries_not_using_indexes</code></a> 系统变量。（即使启用了该变量，服务器也不会记录由于表的行数少于两行而不会从索引的存在中受益的查询。）</p>\n<p><strong>log_throttle_queries_not_using_indexes</strong> 当记录不使用索引的查询时，慢查询日志可能会快速增长。可以通过设置<a href=\"https://dev.mysql.com/doc/refman/5.7/en/server-system-variables.html#sysvar_log_throttle_queries_not_using_indexes\" target=\"_blank\" rel=\"noopener\"><code>log_throttle_queries_not_using_indexes</code></a> 系统变量对这些查询设置速率限制 。默认情况下，此变量为 0，这意味着没有限制。正值对不使用索引的查询的日志记录施加了每分钟限制。第一个这样的查询打开一个 60 秒的窗口，在该窗口中服务器记录查询达到给定的限制，然后抑制其他查询。如果在窗口结束时有被抑制的查询，服务器会记录一个摘要，指示有多少查询以及在这些查询中花费的总时间。当服务器记录下一个不使用索引的查询时，下一个 60 秒窗口开始。</p>\n<p>服务器按照以下顺序使用控制参数来决定是否将查询写入慢查询日志：</p>\n<ul>\n<li>查询必须不是管理语句，或者 <a href=\"https://dev.mysql.com/doc/refman/5.7/en/server-system-variables.html#sysvar_log_slow_admin_statements\" target=\"_blank\" rel=\"noopener\"><code>log_slow_admin_statements</code></a> 必须启用。</li>\n<li>查询必须至少花费了 <a href=\"https://dev.mysql.com/doc/refman/5.7/en/server-system-variables.html#sysvar_long_query_time\" target=\"_blank\" rel=\"noopener\"><code>long_query_time</code></a>几秒钟，或者 <a href=\"https://dev.mysql.com/doc/refman/5.7/en/server-system-variables.html#sysvar_log_queries_not_using_indexes\" target=\"_blank\" rel=\"noopener\"><code>log_queries_not_using_indexes</code></a> 必须启用并且查询没有使用索引进行行查找。</li>\n<li>查询必须至少检查过 <a href=\"https://dev.mysql.com/doc/refman/5.7/en/server-system-variables.html#sysvar_min_examined_row_limit\" target=\"_blank\" rel=\"noopener\"><code>min_examined_row_limit</code></a> 行。</li>\n<li>不得根据<a href=\"https://dev.mysql.com/doc/refman/5.7/en/server-system-variables.html#sysvar_log_throttle_queries_not_using_indexes\" target=\"_blank\" rel=\"noopener\"><code>log_throttle_queries_not_using_indexes</code></a> 设置抑制查询 。</li>\n</ul>\n<h1 id=\"慢查询日志内容\"><a href=\"#慢查询日志内容\" class=\"headerlink\" title=\"慢查询日志内容\"></a>慢查询日志内容</h1><p>启用慢查询日志后，服务器将输出写入<a href=\"https://dev.mysql.com/doc/refman/5.7/en/server-system-variables.html#sysvar_log_output\" target=\"_blank\" rel=\"noopener\"><code>log_output</code></a>系统变量指定的任何目的地 。如果启用日志，服务器将打开日志文件并将启动消息写入其中。但是，除非<code>FILE</code>选择了日志目标，否则不会将查询进一步记录到文件中。如果目标是 <code>NONE</code>，则即使启用了慢查询日志，服务器也不会写入任何查询。如果<code>FILE</code>未选择作为输出目的地，则设置日志文件名对日志记录没有影响。</p>\n<p>如果启用慢查询日志并<code>FILE</code>选择作为输出目标，则写入日志的每个语句前面都有一行以<code>#</code>字符开头 并具有以下字段（所有字段在一行中）：</p>\n<ul>\n<li><p><code>Query_time:</code>duration</p>\n<p>语句执行时间（以秒为单位）。</p>\n</li>\n<li><p><code>Lock_time:</code>duration</p>\n<p>以秒为单位获取锁的时间。</p>\n</li>\n<li><p><code>Rows_sent:</code>N</p>\n<p>发送到客户端的行数。</p>\n</li>\n<li><p><code>Rows_examined:</code></p>\n<p>服务器层检查的行数（不包括存储引擎内部的任何处理）。</p>\n</li>\n</ul>\n<p>写入慢查询日志文件的每个语句前面都有一个<a href=\"https://dev.mysql.com/doc/refman/5.7/en/set-variable.html\" target=\"_blank\" rel=\"noopener\"><code>SET</code></a> 包含时间戳的语句，该时间戳指示记录慢语句的时间（在语句完成执行后发生）。</p>\n<p>写入慢查询日志的语句中的密码由服务器重写，不会以纯文本的形式出现。请参阅<a href=\"https://dev.mysql.com/doc/refman/5.7/en/password-logging.html\" target=\"_blank\" rel=\"noopener\">第 6.1.2.3 节，“密码和日志记录”</a>。</p>\n<h1 id=\"参数配置\"><a href=\"#参数配置\" class=\"headerlink\" title=\"参数配置\"></a>参数配置</h1><h2 id=\"slow-query-log\"><a href=\"#slow-query-log\" class=\"headerlink\" title=\"slow_query_log\"></a>slow_query_log</h2><p>使用<code>set global slow_query_log=1</code>开启了慢查询日志只对当前数据库生效，MySQL重启后则会失效。</p>\n<p>如果要永久生效，就必须修改配置文件<code>my.cnf</code>（其它系统变量也是如此）。</p>\n<p><code>my.cnf</code>要增加或修改参数<code>slow_query_log</code> 和<code>slow_query_log_file</code>，如下所示</p>\n<blockquote>\n<p>slow_query_log = 1</p>\n<p>slow_query_log_file = /tmp/mysql_slow.log</p>\n</blockquote>\n<p>然后重启MySQL服务器。</p>\n<h2 id=\"slow-query-log-file\"><a href=\"#slow-query-log-file\" class=\"headerlink\" title=\"slow_query_log_file\"></a>slow_query_log_file</h2><p>这个参数用于指定慢查询日志的存放路径，缺省情况是<code>host_name-slow.log</code>文件</p>\n<blockquote>\n<p>show variables like ‘slow_query_log_file’</p>\n</blockquote>\n<h2 id=\"long-query-time\"><a href=\"#long-query-time\" class=\"headerlink\" title=\"long_query_time\"></a>long_query_time</h2><p>mysql源码里是判断大于<code>long_query_time</code>，而非大于等于。</p>\n<p>从MySQL 5.1开始，<code>long_query_time</code>开始以<strong>微秒</strong>记录SQL语句运行时间，之前仅用秒为单位记录。</p>\n<p>如果记录到表里面，只会记录整数部分，不会记录微秒部分。</p>\n<p>注意：使用命令 set global long_query_time=4修改后，需要重新连接或新开一个会话才能看到修改值。</p>\n<p>用show variables like ‘long_query_time’查看是当前会话的变量值。</p>\n<p>也可以不用重新连接会话，而是用show global variables like ‘long_query_time’;。</p>\n<h2 id=\"log-output\"><a href=\"#log-output\" class=\"headerlink\" title=\"log_output\"></a>log_output</h2><p>log_output参数指定日志的存储方式。</p>\n<p>log_output=’FILE’表示将日志存入文件，默认值也是’FILE’。</p>\n<p>log_output=’TABLE’表示将日志存入数据库，这样日志信息就会被写入到mysql.slow_log表中。</p>\n<p>同时也支持两种日志存储方式，配置的时候以逗号隔开即可，如：log_output=’FILE,TABLE’。</p>\n<p>日志记录到系统的专用日志表中，要比记录到文件耗费更多的系统资源。</p>\n<p>因此对于需要启用慢查询日志，又需要能够获得更高的系统性能，那么建议优先记录到文件。</p>\n<blockquote>\n<p>show variables like ‘%log_output%’;</p>\n<p>set global log_output=’TABLE’;</p>\n</blockquote>\n<h2 id=\"log-queries-not-using-indexes\"><a href=\"#log-queries-not-using-indexes\" class=\"headerlink\" title=\"log-queries-not-using-indexes\"></a>log-queries-not-using-indexes</h2><p>该系统变量指定<strong>未使用索引的查询</strong>也被记录到慢查询日志中（可选项）。</p>\n<p>如果调优的话，建议开启这个选项。</p>\n<p>另外，开启了这个参数，其实使用<code>full index scan</code>的SQL也会被记录到慢查询日志。</p>\n<blockquote>\n<p>show variables like ‘log_queries_not_using_indexes’;</p>\n<p>set global log_queries_not_using_indexes=1;</p>\n</blockquote>\n<h2 id=\"log-slow-admin-statements\"><a href=\"#log-slow-admin-statements\" class=\"headerlink\" title=\"log_slow_admin_statements\"></a>log_slow_admin_statements</h2><p>这个系统变量表示，是否将慢管理语句例如<code>ANALYZE TABLE</code>和<code>ALTER TABLE</code>等记入慢查询日志。</p>\n<blockquote>\n<p>show variables like ‘log_slow_admin_statements’;</p>\n</blockquote>\n<h2 id=\"Slow-queries\"><a href=\"#Slow-queries\" class=\"headerlink\" title=\"Slow_queries\"></a>Slow_queries</h2><p>如果你想查询有多少条慢查询记录，可以使用<code>Slow_queries</code>系统变量。</p>\n<blockquote>\n<p>show global status like ‘%Slow_queries%’;</p>\n</blockquote>\n<p>另外，还有<code>log_slow_slave_statements</code> 和<code>--log-short-format</code> 参数，可到MySQL网站了解。</p>\n<h1 id=\"mysqldumpslow\"><a href=\"#mysqldumpslow\" class=\"headerlink\" title=\"mysqldumpslow\"></a>mysqldumpslow</h1><p>慢查询日志分析工具<br>mysqldumpslow经常使用的参数：<br>-s，是order的顺序<br>——-al 平均锁定时间<br>——-ar 平均返回记录时间<br>——-at 平均查询时间（默认）<br>——-c 计数<br>——-l 锁定时间<br>——-r 返回记录<br>——-t 查询时间<br>-t，是top n的意思，即为返回前面多少条的数据<br>-g，后边可以写一个正则匹配模式，大小写不敏感的</p>\n<p>比如，得到返回记录集最多的10个SQL。</p>\n<blockquote>\n<p>mysqldumpslow -s r -t 10 /database/mysql/mysql06_slow.log</p>\n</blockquote>\n<p>得到访问次数最多的10个SQL</p>\n<blockquote>\n<p>mysqldumpslow -s c -t 10 /database/mysql/mysql06_slow.log</p>\n</blockquote>\n<p>得到按照时间排序的前10条里面含有左连接的查询语句。</p>\n<blockquote>\n<p>mysqldumpslow -s t -t 10 -g “left join” /database/mysql/mysql06_slow.log</p>\n</blockquote>\n<p>另外建议在使用这些命令时结合 | 和more 使用 ，否则有可能出现刷屏的情况。</p>\n<blockquote>\n<p>mysqldumpslow -s r -t 20 /mysqldata/mysql/mysql06-slow.log | more</p>\n</blockquote>\n","next":{"title":"MySQL之索引简介","path":"api/articles/resource-DB-MySQL-MySQL-index.json","image":"/img/header_img/DB/index.png","num_read":1259,"num_like":339,"num_collection":97,"num_comments":159},"prev":{"title":"分布式锁的解决方案","path":"api/articles/resource-MicroService-seata-distributedLock.json","image":"/img/header_img/MicroService/distributedTransaction.PNG","num_read":619,"num_like":601,"num_collection":764,"num_comments":73},"categories":[{"name":"数据库","path":"api/categories/数据库.json","pathContent":"api/categories/数据库","description":"结构化存储格式+事务和并发控制+内存管理+SQL访问接口","cover":"https://sunfy9.gitee.io/project/photo/project/db.jpg"}],"tags":[{"name":"MySQL","path":"api/tags/MySQL.json","pathContent":"api/tags/MySQL","description":"一种关系型数据库管理系统","cover":"https://sunfy9.gitee.io/project/photo/project/desk.jpg"}]}