{"title":"SpringBoot集成WebSocket通信","num_read":1813,"num_like":601,"num_collection":704,"num_comments":191,"slug":"resource-Spring-SpringBoot-SpringBoot集成WebSocket通信","date":"2020-09-21T16:00:00.000Z","img":"/img/header_img/17.gif","_id":"clhrbp2fs00gco5lg3qbj04ub","project":"Spring","subtitle":"WebSocket协议是基于TCP的一种新的网络协议。实现了浏览器与服务器全双工(full-duplex)通信——允许服务器主动发送信息给客户端","site":{"data":{}},"updated":"2022-03-03T05:21:50.000Z","author":"Sunfy","comments":true,"path":"api/articles/resource-Spring-SpringBoot-SpringBoot集成WebSocket通信.json","webPath":"2020/09/22/resource-Spring-SpringBoot-SpringBoot集成WebSocket通信/","permalink":"https://sunfy9.gitee.io/2020/09/22/resource-Spring-SpringBoot-SpringBoot%E9%9B%86%E6%88%90WebSocket%E9%80%9A%E4%BF%A1/","excerpt":"WebSocket协议是基于TCP的一种新的网络协议。实现了浏览器与服务器全双工(full-duplex)通信——允许服务器主动发送信息给客户端。http协议通信只能由客户端发起请求，做不到服务器直接推送消息给客户端。","covers":null,"keywords":"sunfy, hexo-theme-snail","content":"<p>WebSocket协议是基于TCP的一种新的网络协议。实现了浏览器与服务器全双工(full-duplex)通信——允许服务器主动发送信息给客户端。http协议通信只能由客户端发起请求，做不到服务器直接推送消息给客户端。<a id=\"more\"></a></p>\n<h2 id=\"Maven依赖\"><a href=\"#Maven依赖\" class=\"headerlink\" title=\"Maven依赖\"></a>Maven依赖</h2><figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>org.springframework.boot<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>spring-boot-starter-websocket<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">version</span>&gt;</span>2.1.7.RELEASE<span class=\"tag\">&lt;/<span class=\"name\">version</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<h2 id=\"WebSocketConfig\"><a href=\"#WebSocketConfig\" class=\"headerlink\" title=\"WebSocketConfig\"></a>WebSocketConfig</h2><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.context.annotation.Bean;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.context.annotation.Configuration;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.web.socket.server.standard.ServerEndpointExporter;</span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@Description</span>: 开启webSocket</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@Author</span>: sunfy</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@Date</span>: 2020/11/18 上午9:00</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"meta\">@Configuration</span>  </span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">WebSocketConfig</span> </span>&#123;  </span><br><span class=\"line\">    <span class=\"meta\">@Bean</span>  </span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> ServerEndpointExporter <span class=\"title\">serverEndpointExporter</span><span class=\"params\">()</span> </span>&#123;  </span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> ServerEndpointExporter();  </span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"WebSocketServer\"><a href=\"#WebSocketServer\" class=\"headerlink\" title=\"WebSocketServer\"></a><sunfy-line>WebSocketServer</h2><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br><span class=\"line\">169</span><br><span class=\"line\">170</span><br><span class=\"line\">171</span><br><span class=\"line\">172</span><br><span class=\"line\">173</span><br><span class=\"line\">174</span><br><span class=\"line\">175</span><br><span class=\"line\">176</span><br><span class=\"line\">177</span><br><span class=\"line\">178</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> com.alibaba.fastjson.JSON;</span><br><span class=\"line\"><span class=\"keyword\">import</span> com.alibaba.fastjson.JSONObject;</span><br><span class=\"line\"><span class=\"keyword\">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.stereotype.Component;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.util.StringUtils;</span><br><span class=\"line\"><span class=\"keyword\">import</span> javax.websocket.*;</span><br><span class=\"line\"><span class=\"keyword\">import</span> javax.websocket.server.PathParam;</span><br><span class=\"line\"><span class=\"keyword\">import</span> javax.websocket.server.ServerEndpoint;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.io.IOException;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.util.concurrent.ConcurrentHashMap;</span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@Description</span>: 接受客户端连接</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@Author</span>: sunfy</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@Date</span>: 2020/11/18 上午9:00</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"meta\">@ServerEndpoint</span>(<span class=\"string\">\"/imserver/&#123;userId&#125;\"</span>)</span><br><span class=\"line\"><span class=\"meta\">@Component</span></span><br><span class=\"line\"><span class=\"meta\">@Slf</span>4j</span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">WebSocketServer</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * 静态变量，用来记录当前在线连接数。应该把它设计成线程安全的。</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">int</span> onlineCount = <span class=\"number\">0</span>;</span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * concurrent包的线程安全Set，用来存放每个客户端对应的MyWebSocket对象。</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> ConcurrentHashMap&lt;String, WebSocketServer&gt; webSocketMap = <span class=\"keyword\">new</span> ConcurrentHashMap&lt;&gt;();</span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * 与某个客户端的连接会话，需要通过它来给客户端发送数据</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> Session session;</span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * 接收userId</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> String userId = <span class=\"string\">\"\"</span>;</span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@Description</span>: 建立成功后调用的方法</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@Param</span>:</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@return</span>:</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@Author</span>: sunfy</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@Date</span>: 2020/11/18 上午9:02</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"meta\">@OnOpen</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">onOpen</span><span class=\"params\">(Session session, @PathParam(<span class=\"string\">\"userId\"</span>)</span> String userId) </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.session = session;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.userId = userId;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (webSocketMap.containsKey(userId)) &#123;</span><br><span class=\"line\">            webSocketMap.remove(userId);</span><br><span class=\"line\">            webSocketMap.put(userId, <span class=\"keyword\">this</span>);</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">            webSocketMap.put(userId, <span class=\"keyword\">this</span>);</span><br><span class=\"line\">            <span class=\"comment\">// 在线人数</span></span><br><span class=\"line\">            addOnlineCount();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        log.info(<span class=\"string\">\"用户连接:\"</span> + userId + <span class=\"string\">\",当前在线人数为:\"</span> + getOnlineCount());</span><br><span class=\"line\">        <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">            sendMessage(<span class=\"string\">\"连接成功\"</span>);</span><br><span class=\"line\">        &#125; <span class=\"keyword\">catch</span> (IOException e) &#123;</span><br><span class=\"line\">            log.error(<span class=\"string\">\"用户:\"</span> + userId + <span class=\"string\">\",网络异常!!!!!!\"</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@Description</span>: 连接关闭调用的方法</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@Param</span>: </span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@return</span>: </span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@Author</span>: sunfy</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@Date</span>: 2020/11/18 上午9:04</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"meta\">@OnClose</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">onClose</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (webSocketMap.containsKey(userId)) &#123;</span><br><span class=\"line\">            <span class=\"comment\">//从set中删除</span></span><br><span class=\"line\">            webSocketMap.remove(userId);</span><br><span class=\"line\">            subOnlineCount();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        log.info(<span class=\"string\">\"用户退出:\"</span> + userId + <span class=\"string\">\",当前在线人数为:\"</span> + getOnlineCount());</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@description</span></span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> message 客户端发送过来的消息</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> session 客户端session</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@return</span></span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@author</span>: sunfy</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@Date</span>: 2020/11/18 上午9:04</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"meta\">@OnMessage</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">onMessage</span><span class=\"params\">(String message, Session session)</span> </span>&#123;</span><br><span class=\"line\">        log.info(<span class=\"string\">\"用户消息:\"</span> + userId + <span class=\"string\">\",报文:\"</span> + message);</span><br><span class=\"line\">        <span class=\"comment\">//可以群发消息</span></span><br><span class=\"line\">        <span class=\"comment\">//消息保存到数据库、redis</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (!StringUtils.isEmpty(message)) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">                <span class=\"comment\">//解析发送的报文</span></span><br><span class=\"line\">                JSONObject jsonObject = JSON.parseObject(message);</span><br><span class=\"line\">                <span class=\"comment\">//追加发送人(防止串改)</span></span><br><span class=\"line\">                jsonObject.put(<span class=\"string\">\"fromUserId\"</span>, <span class=\"keyword\">this</span>.userId);</span><br><span class=\"line\">                String toUserId = jsonObject.getString(<span class=\"string\">\"toUserId\"</span>);</span><br><span class=\"line\">                <span class=\"comment\">//传送给对应toUserId用户的websocket</span></span><br><span class=\"line\">                <span class=\"keyword\">if</span> (!StringUtils.isEmpty(toUserId) &amp;&amp; webSocketMap.containsKey(toUserId)) &#123;</span><br><span class=\"line\">                    webSocketMap.get(toUserId).sendMessage(jsonObject.toJSONString());</span><br><span class=\"line\">                &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">                    log.error(<span class=\"string\">\"请求的userId:\"</span> + toUserId + <span class=\"string\">\"不在该服务器上\"</span>);</span><br><span class=\"line\">                    <span class=\"comment\">//否则不在这个服务器上，发送到mysql或者redis</span></span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125; <span class=\"keyword\">catch</span> (Exception e) &#123;</span><br><span class=\"line\">                e.printStackTrace();</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@Description</span>: 发送消息错误时</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> session 客户端session</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> error 错误</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@return</span>: </span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@Author</span>: sunfy</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@Date</span>: 2020/11/18 上午9:07</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"meta\">@OnError</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">onError</span><span class=\"params\">(Session session, Throwable error)</span> </span>&#123;</span><br><span class=\"line\">        log.error(<span class=\"string\">\"用户错误:\"</span> + <span class=\"keyword\">this</span>.userId + <span class=\"string\">\",原因:\"</span> + error.getMessage());</span><br><span class=\"line\">        error.printStackTrace();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@Description</span>: 服务器主动推送消息</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@Param</span>: </span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@return</span>: </span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@Author</span>: sunfy</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@Date</span>: 2020/11/18 上午9:09</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">sendMessage</span><span class=\"params\">(String message)</span> <span class=\"keyword\">throws</span> IOException </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.session.getBasicRemote().sendText(message);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@Description</span>: 发送自定义消息</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@Param</span>: </span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@return</span>: </span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@Author</span>: sunfy</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@Date</span>: 2020/11/18 上午9:10</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">sendInfo</span><span class=\"params\">(String message, @PathParam(<span class=\"string\">\"userId\"</span>)</span> String userId) <span class=\"keyword\">throws</span> IOException </span>&#123;</span><br><span class=\"line\">        log.info(<span class=\"string\">\"发送消息到:\"</span> + userId + <span class=\"string\">\"，报文:\"</span> + message);</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (!StringUtils.isEmpty(userId) &amp;&amp; webSocketMap.containsKey(userId)) &#123;</span><br><span class=\"line\">            webSocketMap.get(userId).sendMessage(message);</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">            log.error(<span class=\"string\">\"用户\"</span> + userId + <span class=\"string\">\",不在线！\"</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@Description</span>: 获取当前在线人数</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@Param</span>: </span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@return</span>: </span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@Author</span>: sunfy</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@Date</span>: 2020/11/18 上午9:10</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">synchronized</span> <span class=\"keyword\">int</span> <span class=\"title\">getOnlineCount</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> onlineCount;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@Description</span>: 增加在线人数</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@Param</span>: </span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@return</span>: </span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@Author</span>: sunfy</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@Date</span>: 2020/11/18 上午9:10</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">synchronized</span> <span class=\"keyword\">void</span> <span class=\"title\">addOnlineCount</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        WebSocketServer.onlineCount++;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@Description</span>: 在线人数减1</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@Param</span>: </span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@return</span>: </span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@Author</span>: sunfy</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@Date</span>: 2020/11/18 上午9:11</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">synchronized</span> <span class=\"keyword\">void</span> <span class=\"title\">subOnlineCount</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        WebSocketServer.onlineCount--;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"测试Controller\"><a href=\"#测试Controller\" class=\"headerlink\" title=\"测试Controller\"></a>测试Controller</h2><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> com.sunfy.config.WebSocketServer;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.http.ResponseEntity;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.web.bind.annotation.PathVariable;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.web.servlet.ModelAndView;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.io.IOException;</span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@Description</span>: 测试Controller</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@Param</span>: </span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@return</span>: </span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@Author</span>: sunfy</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@Date</span>: 2020/11/18 上午9:13</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"meta\">@RestController</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">DemoController</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"meta\">@GetMapping</span>(<span class=\"string\">\"index\"</span>)</span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> ResponseEntity&lt;String&gt; <span class=\"title\">index</span><span class=\"params\">()</span></span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> ResponseEntity.ok(<span class=\"string\">\"请求成功\"</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"meta\">@GetMapping</span>(<span class=\"string\">\"page\"</span>)</span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> ModelAndView <span class=\"title\">page</span><span class=\"params\">()</span></span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> ModelAndView(<span class=\"string\">\"websocket\"</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"meta\">@RequestMapping</span>(<span class=\"string\">\"/push/&#123;toUserId&#125;\"</span>)</span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> ResponseEntity&lt;String&gt; <span class=\"title\">pushToWeb</span><span class=\"params\">(String message, @PathVariable String toUserId)</span> <span class=\"keyword\">throws</span> IOException </span>&#123;</span><br><span class=\"line\">        WebSocketServer.sendInfo(message,toUserId);</span><br><span class=\"line\">        <span class=\"keyword\">return</span> ResponseEntity.ok(<span class=\"string\">\"MSG SEND SUCCESS\"</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"前端测试代码\"><a href=\"#前端测试代码\" class=\"headerlink\" title=\"前端测试代码\"></a>前端测试代码</h2><figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;!DOCTYPE <span class=\"meta-keyword\">html</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">html</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">head</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">meta</span> <span class=\"attr\">charset</span>=<span class=\"string\">\"utf-8\"</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">title</span>&gt;</span>websocket通讯<span class=\"tag\">&lt;/<span class=\"name\">title</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">head</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">src</span>=<span class=\"string\">\"https://cdn.bootcss.com/jquery/3.3.1/jquery.js\"</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\"><span class=\"actionscript\">    <span class=\"keyword\">var</span> socket;</span></span><br><span class=\"line\"><span class=\"actionscript\">    <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">openSocket</span><span class=\"params\">()</span> </span>&#123;</span></span><br><span class=\"line\"><span class=\"actionscript\">        <span class=\"keyword\">if</span> (<span class=\"keyword\">typeof</span> (WebSocket) == <span class=\"string\">\"undefined\"</span>) &#123;</span></span><br><span class=\"line\"><span class=\"javascript\">            <span class=\"built_in\">console</span>.log(<span class=\"string\">\"您的浏览器不支持WebSocket\"</span>);</span></span><br><span class=\"line\"><span class=\"actionscript\">        &#125; <span class=\"keyword\">else</span> &#123;</span></span><br><span class=\"line\"><span class=\"javascript\">            <span class=\"built_in\">console</span>.log(<span class=\"string\">\"您的浏览器支持WebSocket\"</span>);</span></span><br><span class=\"line\"><span class=\"actionscript\">            <span class=\"comment\">//实现化WebSocket对象，指定要连接的服务器地址与端口  建立连接</span></span></span><br><span class=\"line\"><span class=\"actionscript\">            <span class=\"comment\">//等同于socket = new WebSocket(\"ws://localhost:8888/xxxx/im/25\");</span></span></span><br><span class=\"line\"><span class=\"actionscript\">            <span class=\"comment\">//var socketUrl=\"$&#123;request.contextPath&#125;/im/\"+$(\"#userId\").val();</span></span></span><br><span class=\"line\"><span class=\"javascript\">            <span class=\"keyword\">var</span> socketUrl = <span class=\"string\">\"http://localhost:8080/imserver/\"</span> + $(<span class=\"string\">\"#userId\"</span>).val();</span></span><br><span class=\"line\"><span class=\"actionscript\">            socketUrl = socketUrl.replace(<span class=\"string\">\"https\"</span>, <span class=\"string\">\"ws\"</span>).replace(<span class=\"string\">\"http\"</span>, <span class=\"string\">\"ws\"</span>);</span></span><br><span class=\"line\"><span class=\"javascript\">            <span class=\"built_in\">console</span>.log(socketUrl);</span></span><br><span class=\"line\"><span class=\"actionscript\">            <span class=\"keyword\">if</span> (socket != <span class=\"literal\">null</span>) &#123;</span></span><br><span class=\"line\">                socket.close();</span><br><span class=\"line\"><span class=\"actionscript\">                socket = <span class=\"literal\">null</span>;</span></span><br><span class=\"line\">            &#125;</span><br><span class=\"line\"><span class=\"actionscript\">            socket = <span class=\"keyword\">new</span> WebSocket(socketUrl);</span></span><br><span class=\"line\"><span class=\"actionscript\">            <span class=\"comment\">//打开事件</span></span></span><br><span class=\"line\"><span class=\"actionscript\">            socket.onopen = <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"params\">()</span> </span>&#123;</span></span><br><span class=\"line\"><span class=\"javascript\">                <span class=\"built_in\">console</span>.log(<span class=\"string\">\"websocket已打开\"</span>);</span></span><br><span class=\"line\"><span class=\"actionscript\">                <span class=\"comment\">//socket.send(\"这是来自客户端的消息\" + location.href + new Date());</span></span></span><br><span class=\"line\">            &#125;;</span><br><span class=\"line\"><span class=\"actionscript\">            <span class=\"comment\">//获得消息事件</span></span></span><br><span class=\"line\"><span class=\"actionscript\">            socket.onmessage = <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"params\">(msg)</span> </span>&#123;</span></span><br><span class=\"line\"><span class=\"javascript\">                <span class=\"built_in\">console</span>.log(msg.data);</span></span><br><span class=\"line\"><span class=\"actionscript\">                <span class=\"comment\">//发现消息进入    开始处理前端触发逻辑</span></span></span><br><span class=\"line\">            &#125;;</span><br><span class=\"line\"><span class=\"actionscript\">            <span class=\"comment\">//关闭事件</span></span></span><br><span class=\"line\"><span class=\"actionscript\">            socket.onclose = <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"params\">()</span> </span>&#123;</span></span><br><span class=\"line\"><span class=\"javascript\">                <span class=\"built_in\">console</span>.log(<span class=\"string\">\"websocket已关闭\"</span>);</span></span><br><span class=\"line\">            &#125;;</span><br><span class=\"line\"><span class=\"actionscript\">            <span class=\"comment\">//发生了错误事件</span></span></span><br><span class=\"line\"><span class=\"actionscript\">            socket.onerror = <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"params\">()</span> </span>&#123;</span></span><br><span class=\"line\"><span class=\"javascript\">                <span class=\"built_in\">console</span>.log(<span class=\"string\">\"websocket发生了错误\"</span>);</span></span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"><span class=\"actionscript\">    <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">sendMessage</span><span class=\"params\">()</span> </span>&#123;</span></span><br><span class=\"line\"><span class=\"actionscript\">        <span class=\"keyword\">if</span> (<span class=\"keyword\">typeof</span> (WebSocket) == <span class=\"string\">\"undefined\"</span>) &#123;</span></span><br><span class=\"line\"><span class=\"javascript\">            <span class=\"built_in\">console</span>.log(<span class=\"string\">\"您的浏览器不支持WebSocket\"</span>);</span></span><br><span class=\"line\"><span class=\"actionscript\">        &#125; <span class=\"keyword\">else</span> &#123;</span></span><br><span class=\"line\"><span class=\"javascript\">            <span class=\"built_in\">console</span>.log(<span class=\"string\">\"您的浏览器支持WebSocket\"</span>);</span></span><br><span class=\"line\"><span class=\"javascript\">            <span class=\"built_in\">console</span>.log(<span class=\"string\">'&#123;\"toUserId\":\"'</span> + $(<span class=\"string\">\"#toUserId\"</span>).val() + <span class=\"string\">'\",\"contentText\":\"'</span> + $(<span class=\"string\">\"#contentText\"</span>).val() + <span class=\"string\">'\"&#125;'</span>);</span></span><br><span class=\"line\"><span class=\"javascript\">            socket.send(<span class=\"string\">'&#123;\"toUserId\":\"'</span> + $(<span class=\"string\">\"#toUserId\"</span>).val() + <span class=\"string\">'\",\"contentText\":\"'</span> + $(<span class=\"string\">\"#contentText\"</span>).val() + <span class=\"string\">'\"&#125;'</span>);</span></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">body</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">p</span>&gt;</span>【userId】：</span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">div</span>&gt;</span><span class=\"tag\">&lt;<span class=\"name\">input</span> <span class=\"attr\">id</span>=<span class=\"string\">\"userId\"</span> <span class=\"attr\">name</span>=<span class=\"string\">\"userId\"</span> <span class=\"attr\">type</span>=<span class=\"string\">\"text\"</span> <span class=\"attr\">value</span>=<span class=\"string\">\"10\"</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">div</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">p</span>&gt;</span>【toUserId】：</span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">div</span>&gt;</span><span class=\"tag\">&lt;<span class=\"name\">input</span> <span class=\"attr\">id</span>=<span class=\"string\">\"toUserId\"</span> <span class=\"attr\">name</span>=<span class=\"string\">\"toUserId\"</span> <span class=\"attr\">type</span>=<span class=\"string\">\"text\"</span> <span class=\"attr\">value</span>=<span class=\"string\">\"20\"</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">div</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">p</span>&gt;</span>【toUserId】：</span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">div</span>&gt;</span><span class=\"tag\">&lt;<span class=\"name\">input</span> <span class=\"attr\">id</span>=<span class=\"string\">\"contentText\"</span> <span class=\"attr\">name</span>=<span class=\"string\">\"contentText\"</span> <span class=\"attr\">type</span>=<span class=\"string\">\"text\"</span> <span class=\"attr\">value</span>=<span class=\"string\">\"hello websocket\"</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">div</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">p</span>&gt;</span>【操作】：</span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">div</span>&gt;</span><span class=\"tag\">&lt;<span class=\"name\">a</span> <span class=\"attr\">onclick</span>=<span class=\"string\">\"openSocket()\"</span>&gt;</span>开启socket<span class=\"tag\">&lt;/<span class=\"name\">a</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">div</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">p</span>&gt;</span>【操作】：</span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">div</span>&gt;</span><span class=\"tag\">&lt;<span class=\"name\">a</span> <span class=\"attr\">onclick</span>=<span class=\"string\">\"sendMessage()\"</span>&gt;</span>发送消息<span class=\"tag\">&lt;/<span class=\"name\">a</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">div</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">body</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">html</span>&gt;</span></span><br></pre></td></tr></table></figure>\n","more":"</p>\n<h2 id=\"Maven依赖\"><a href=\"#Maven依赖\" class=\"headerlink\" title=\"Maven依赖\"></a>Maven依赖</h2><figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>org.springframework.boot<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>spring-boot-starter-websocket<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">version</span>&gt;</span>2.1.7.RELEASE<span class=\"tag\">&lt;/<span class=\"name\">version</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<h2 id=\"WebSocketConfig\"><a href=\"#WebSocketConfig\" class=\"headerlink\" title=\"WebSocketConfig\"></a>WebSocketConfig</h2><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.context.annotation.Bean;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.context.annotation.Configuration;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.web.socket.server.standard.ServerEndpointExporter;</span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@Description</span>: 开启webSocket</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@Author</span>: sunfy</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@Date</span>: 2020/11/18 上午9:00</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"meta\">@Configuration</span>  </span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">WebSocketConfig</span> </span>&#123;  </span><br><span class=\"line\">    <span class=\"meta\">@Bean</span>  </span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> ServerEndpointExporter <span class=\"title\">serverEndpointExporter</span><span class=\"params\">()</span> </span>&#123;  </span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> ServerEndpointExporter();  </span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"WebSocketServer\"><a href=\"#WebSocketServer\" class=\"headerlink\" title=\"WebSocketServer\"></a><sunfy-line>WebSocketServer</h2><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br><span class=\"line\">169</span><br><span class=\"line\">170</span><br><span class=\"line\">171</span><br><span class=\"line\">172</span><br><span class=\"line\">173</span><br><span class=\"line\">174</span><br><span class=\"line\">175</span><br><span class=\"line\">176</span><br><span class=\"line\">177</span><br><span class=\"line\">178</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> com.alibaba.fastjson.JSON;</span><br><span class=\"line\"><span class=\"keyword\">import</span> com.alibaba.fastjson.JSONObject;</span><br><span class=\"line\"><span class=\"keyword\">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.stereotype.Component;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.util.StringUtils;</span><br><span class=\"line\"><span class=\"keyword\">import</span> javax.websocket.*;</span><br><span class=\"line\"><span class=\"keyword\">import</span> javax.websocket.server.PathParam;</span><br><span class=\"line\"><span class=\"keyword\">import</span> javax.websocket.server.ServerEndpoint;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.io.IOException;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.util.concurrent.ConcurrentHashMap;</span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@Description</span>: 接受客户端连接</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@Author</span>: sunfy</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@Date</span>: 2020/11/18 上午9:00</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"meta\">@ServerEndpoint</span>(<span class=\"string\">\"/imserver/&#123;userId&#125;\"</span>)</span><br><span class=\"line\"><span class=\"meta\">@Component</span></span><br><span class=\"line\"><span class=\"meta\">@Slf</span>4j</span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">WebSocketServer</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * 静态变量，用来记录当前在线连接数。应该把它设计成线程安全的。</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">int</span> onlineCount = <span class=\"number\">0</span>;</span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * concurrent包的线程安全Set，用来存放每个客户端对应的MyWebSocket对象。</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> ConcurrentHashMap&lt;String, WebSocketServer&gt; webSocketMap = <span class=\"keyword\">new</span> ConcurrentHashMap&lt;&gt;();</span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * 与某个客户端的连接会话，需要通过它来给客户端发送数据</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> Session session;</span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * 接收userId</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> String userId = <span class=\"string\">\"\"</span>;</span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@Description</span>: 建立成功后调用的方法</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@Param</span>:</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@return</span>:</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@Author</span>: sunfy</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@Date</span>: 2020/11/18 上午9:02</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"meta\">@OnOpen</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">onOpen</span><span class=\"params\">(Session session, @PathParam(<span class=\"string\">\"userId\"</span>)</span> String userId) </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.session = session;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.userId = userId;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (webSocketMap.containsKey(userId)) &#123;</span><br><span class=\"line\">            webSocketMap.remove(userId);</span><br><span class=\"line\">            webSocketMap.put(userId, <span class=\"keyword\">this</span>);</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">            webSocketMap.put(userId, <span class=\"keyword\">this</span>);</span><br><span class=\"line\">            <span class=\"comment\">// 在线人数</span></span><br><span class=\"line\">            addOnlineCount();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        log.info(<span class=\"string\">\"用户连接:\"</span> + userId + <span class=\"string\">\",当前在线人数为:\"</span> + getOnlineCount());</span><br><span class=\"line\">        <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">            sendMessage(<span class=\"string\">\"连接成功\"</span>);</span><br><span class=\"line\">        &#125; <span class=\"keyword\">catch</span> (IOException e) &#123;</span><br><span class=\"line\">            log.error(<span class=\"string\">\"用户:\"</span> + userId + <span class=\"string\">\",网络异常!!!!!!\"</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@Description</span>: 连接关闭调用的方法</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@Param</span>: </span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@return</span>: </span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@Author</span>: sunfy</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@Date</span>: 2020/11/18 上午9:04</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"meta\">@OnClose</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">onClose</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (webSocketMap.containsKey(userId)) &#123;</span><br><span class=\"line\">            <span class=\"comment\">//从set中删除</span></span><br><span class=\"line\">            webSocketMap.remove(userId);</span><br><span class=\"line\">            subOnlineCount();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        log.info(<span class=\"string\">\"用户退出:\"</span> + userId + <span class=\"string\">\",当前在线人数为:\"</span> + getOnlineCount());</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@description</span></span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> message 客户端发送过来的消息</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> session 客户端session</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@return</span></span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@author</span>: sunfy</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@Date</span>: 2020/11/18 上午9:04</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"meta\">@OnMessage</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">onMessage</span><span class=\"params\">(String message, Session session)</span> </span>&#123;</span><br><span class=\"line\">        log.info(<span class=\"string\">\"用户消息:\"</span> + userId + <span class=\"string\">\",报文:\"</span> + message);</span><br><span class=\"line\">        <span class=\"comment\">//可以群发消息</span></span><br><span class=\"line\">        <span class=\"comment\">//消息保存到数据库、redis</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (!StringUtils.isEmpty(message)) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">                <span class=\"comment\">//解析发送的报文</span></span><br><span class=\"line\">                JSONObject jsonObject = JSON.parseObject(message);</span><br><span class=\"line\">                <span class=\"comment\">//追加发送人(防止串改)</span></span><br><span class=\"line\">                jsonObject.put(<span class=\"string\">\"fromUserId\"</span>, <span class=\"keyword\">this</span>.userId);</span><br><span class=\"line\">                String toUserId = jsonObject.getString(<span class=\"string\">\"toUserId\"</span>);</span><br><span class=\"line\">                <span class=\"comment\">//传送给对应toUserId用户的websocket</span></span><br><span class=\"line\">                <span class=\"keyword\">if</span> (!StringUtils.isEmpty(toUserId) &amp;&amp; webSocketMap.containsKey(toUserId)) &#123;</span><br><span class=\"line\">                    webSocketMap.get(toUserId).sendMessage(jsonObject.toJSONString());</span><br><span class=\"line\">                &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">                    log.error(<span class=\"string\">\"请求的userId:\"</span> + toUserId + <span class=\"string\">\"不在该服务器上\"</span>);</span><br><span class=\"line\">                    <span class=\"comment\">//否则不在这个服务器上，发送到mysql或者redis</span></span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125; <span class=\"keyword\">catch</span> (Exception e) &#123;</span><br><span class=\"line\">                e.printStackTrace();</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@Description</span>: 发送消息错误时</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> session 客户端session</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> error 错误</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@return</span>: </span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@Author</span>: sunfy</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@Date</span>: 2020/11/18 上午9:07</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"meta\">@OnError</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">onError</span><span class=\"params\">(Session session, Throwable error)</span> </span>&#123;</span><br><span class=\"line\">        log.error(<span class=\"string\">\"用户错误:\"</span> + <span class=\"keyword\">this</span>.userId + <span class=\"string\">\",原因:\"</span> + error.getMessage());</span><br><span class=\"line\">        error.printStackTrace();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@Description</span>: 服务器主动推送消息</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@Param</span>: </span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@return</span>: </span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@Author</span>: sunfy</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@Date</span>: 2020/11/18 上午9:09</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">sendMessage</span><span class=\"params\">(String message)</span> <span class=\"keyword\">throws</span> IOException </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.session.getBasicRemote().sendText(message);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@Description</span>: 发送自定义消息</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@Param</span>: </span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@return</span>: </span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@Author</span>: sunfy</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@Date</span>: 2020/11/18 上午9:10</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">sendInfo</span><span class=\"params\">(String message, @PathParam(<span class=\"string\">\"userId\"</span>)</span> String userId) <span class=\"keyword\">throws</span> IOException </span>&#123;</span><br><span class=\"line\">        log.info(<span class=\"string\">\"发送消息到:\"</span> + userId + <span class=\"string\">\"，报文:\"</span> + message);</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (!StringUtils.isEmpty(userId) &amp;&amp; webSocketMap.containsKey(userId)) &#123;</span><br><span class=\"line\">            webSocketMap.get(userId).sendMessage(message);</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">            log.error(<span class=\"string\">\"用户\"</span> + userId + <span class=\"string\">\",不在线！\"</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@Description</span>: 获取当前在线人数</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@Param</span>: </span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@return</span>: </span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@Author</span>: sunfy</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@Date</span>: 2020/11/18 上午9:10</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">synchronized</span> <span class=\"keyword\">int</span> <span class=\"title\">getOnlineCount</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> onlineCount;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@Description</span>: 增加在线人数</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@Param</span>: </span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@return</span>: </span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@Author</span>: sunfy</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@Date</span>: 2020/11/18 上午9:10</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">synchronized</span> <span class=\"keyword\">void</span> <span class=\"title\">addOnlineCount</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        WebSocketServer.onlineCount++;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@Description</span>: 在线人数减1</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@Param</span>: </span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@return</span>: </span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@Author</span>: sunfy</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@Date</span>: 2020/11/18 上午9:11</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">synchronized</span> <span class=\"keyword\">void</span> <span class=\"title\">subOnlineCount</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        WebSocketServer.onlineCount--;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"测试Controller\"><a href=\"#测试Controller\" class=\"headerlink\" title=\"测试Controller\"></a>测试Controller</h2><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> com.sunfy.config.WebSocketServer;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.http.ResponseEntity;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.web.bind.annotation.PathVariable;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.web.servlet.ModelAndView;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.io.IOException;</span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@Description</span>: 测试Controller</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@Param</span>: </span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@return</span>: </span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@Author</span>: sunfy</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@Date</span>: 2020/11/18 上午9:13</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"meta\">@RestController</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">DemoController</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"meta\">@GetMapping</span>(<span class=\"string\">\"index\"</span>)</span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> ResponseEntity&lt;String&gt; <span class=\"title\">index</span><span class=\"params\">()</span></span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> ResponseEntity.ok(<span class=\"string\">\"请求成功\"</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"meta\">@GetMapping</span>(<span class=\"string\">\"page\"</span>)</span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> ModelAndView <span class=\"title\">page</span><span class=\"params\">()</span></span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> ModelAndView(<span class=\"string\">\"websocket\"</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"meta\">@RequestMapping</span>(<span class=\"string\">\"/push/&#123;toUserId&#125;\"</span>)</span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> ResponseEntity&lt;String&gt; <span class=\"title\">pushToWeb</span><span class=\"params\">(String message, @PathVariable String toUserId)</span> <span class=\"keyword\">throws</span> IOException </span>&#123;</span><br><span class=\"line\">        WebSocketServer.sendInfo(message,toUserId);</span><br><span class=\"line\">        <span class=\"keyword\">return</span> ResponseEntity.ok(<span class=\"string\">\"MSG SEND SUCCESS\"</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"前端测试代码\"><a href=\"#前端测试代码\" class=\"headerlink\" title=\"前端测试代码\"></a>前端测试代码</h2><figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;!DOCTYPE <span class=\"meta-keyword\">html</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">html</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">head</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">meta</span> <span class=\"attr\">charset</span>=<span class=\"string\">\"utf-8\"</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">title</span>&gt;</span>websocket通讯<span class=\"tag\">&lt;/<span class=\"name\">title</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">head</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">src</span>=<span class=\"string\">\"https://cdn.bootcss.com/jquery/3.3.1/jquery.js\"</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\"><span class=\"actionscript\">    <span class=\"keyword\">var</span> socket;</span></span><br><span class=\"line\"><span class=\"actionscript\">    <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">openSocket</span><span class=\"params\">()</span> </span>&#123;</span></span><br><span class=\"line\"><span class=\"actionscript\">        <span class=\"keyword\">if</span> (<span class=\"keyword\">typeof</span> (WebSocket) == <span class=\"string\">\"undefined\"</span>) &#123;</span></span><br><span class=\"line\"><span class=\"javascript\">            <span class=\"built_in\">console</span>.log(<span class=\"string\">\"您的浏览器不支持WebSocket\"</span>);</span></span><br><span class=\"line\"><span class=\"actionscript\">        &#125; <span class=\"keyword\">else</span> &#123;</span></span><br><span class=\"line\"><span class=\"javascript\">            <span class=\"built_in\">console</span>.log(<span class=\"string\">\"您的浏览器支持WebSocket\"</span>);</span></span><br><span class=\"line\"><span class=\"actionscript\">            <span class=\"comment\">//实现化WebSocket对象，指定要连接的服务器地址与端口  建立连接</span></span></span><br><span class=\"line\"><span class=\"actionscript\">            <span class=\"comment\">//等同于socket = new WebSocket(\"ws://localhost:8888/xxxx/im/25\");</span></span></span><br><span class=\"line\"><span class=\"actionscript\">            <span class=\"comment\">//var socketUrl=\"$&#123;request.contextPath&#125;/im/\"+$(\"#userId\").val();</span></span></span><br><span class=\"line\"><span class=\"javascript\">            <span class=\"keyword\">var</span> socketUrl = <span class=\"string\">\"http://localhost:8080/imserver/\"</span> + $(<span class=\"string\">\"#userId\"</span>).val();</span></span><br><span class=\"line\"><span class=\"actionscript\">            socketUrl = socketUrl.replace(<span class=\"string\">\"https\"</span>, <span class=\"string\">\"ws\"</span>).replace(<span class=\"string\">\"http\"</span>, <span class=\"string\">\"ws\"</span>);</span></span><br><span class=\"line\"><span class=\"javascript\">            <span class=\"built_in\">console</span>.log(socketUrl);</span></span><br><span class=\"line\"><span class=\"actionscript\">            <span class=\"keyword\">if</span> (socket != <span class=\"literal\">null</span>) &#123;</span></span><br><span class=\"line\">                socket.close();</span><br><span class=\"line\"><span class=\"actionscript\">                socket = <span class=\"literal\">null</span>;</span></span><br><span class=\"line\">            &#125;</span><br><span class=\"line\"><span class=\"actionscript\">            socket = <span class=\"keyword\">new</span> WebSocket(socketUrl);</span></span><br><span class=\"line\"><span class=\"actionscript\">            <span class=\"comment\">//打开事件</span></span></span><br><span class=\"line\"><span class=\"actionscript\">            socket.onopen = <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"params\">()</span> </span>&#123;</span></span><br><span class=\"line\"><span class=\"javascript\">                <span class=\"built_in\">console</span>.log(<span class=\"string\">\"websocket已打开\"</span>);</span></span><br><span class=\"line\"><span class=\"actionscript\">                <span class=\"comment\">//socket.send(\"这是来自客户端的消息\" + location.href + new Date());</span></span></span><br><span class=\"line\">            &#125;;</span><br><span class=\"line\"><span class=\"actionscript\">            <span class=\"comment\">//获得消息事件</span></span></span><br><span class=\"line\"><span class=\"actionscript\">            socket.onmessage = <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"params\">(msg)</span> </span>&#123;</span></span><br><span class=\"line\"><span class=\"javascript\">                <span class=\"built_in\">console</span>.log(msg.data);</span></span><br><span class=\"line\"><span class=\"actionscript\">                <span class=\"comment\">//发现消息进入    开始处理前端触发逻辑</span></span></span><br><span class=\"line\">            &#125;;</span><br><span class=\"line\"><span class=\"actionscript\">            <span class=\"comment\">//关闭事件</span></span></span><br><span class=\"line\"><span class=\"actionscript\">            socket.onclose = <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"params\">()</span> </span>&#123;</span></span><br><span class=\"line\"><span class=\"javascript\">                <span class=\"built_in\">console</span>.log(<span class=\"string\">\"websocket已关闭\"</span>);</span></span><br><span class=\"line\">            &#125;;</span><br><span class=\"line\"><span class=\"actionscript\">            <span class=\"comment\">//发生了错误事件</span></span></span><br><span class=\"line\"><span class=\"actionscript\">            socket.onerror = <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"params\">()</span> </span>&#123;</span></span><br><span class=\"line\"><span class=\"javascript\">                <span class=\"built_in\">console</span>.log(<span class=\"string\">\"websocket发生了错误\"</span>);</span></span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"><span class=\"actionscript\">    <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">sendMessage</span><span class=\"params\">()</span> </span>&#123;</span></span><br><span class=\"line\"><span class=\"actionscript\">        <span class=\"keyword\">if</span> (<span class=\"keyword\">typeof</span> (WebSocket) == <span class=\"string\">\"undefined\"</span>) &#123;</span></span><br><span class=\"line\"><span class=\"javascript\">            <span class=\"built_in\">console</span>.log(<span class=\"string\">\"您的浏览器不支持WebSocket\"</span>);</span></span><br><span class=\"line\"><span class=\"actionscript\">        &#125; <span class=\"keyword\">else</span> &#123;</span></span><br><span class=\"line\"><span class=\"javascript\">            <span class=\"built_in\">console</span>.log(<span class=\"string\">\"您的浏览器支持WebSocket\"</span>);</span></span><br><span class=\"line\"><span class=\"javascript\">            <span class=\"built_in\">console</span>.log(<span class=\"string\">'&#123;\"toUserId\":\"'</span> + $(<span class=\"string\">\"#toUserId\"</span>).val() + <span class=\"string\">'\",\"contentText\":\"'</span> + $(<span class=\"string\">\"#contentText\"</span>).val() + <span class=\"string\">'\"&#125;'</span>);</span></span><br><span class=\"line\"><span class=\"javascript\">            socket.send(<span class=\"string\">'&#123;\"toUserId\":\"'</span> + $(<span class=\"string\">\"#toUserId\"</span>).val() + <span class=\"string\">'\",\"contentText\":\"'</span> + $(<span class=\"string\">\"#contentText\"</span>).val() + <span class=\"string\">'\"&#125;'</span>);</span></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">body</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">p</span>&gt;</span>【userId】：</span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">div</span>&gt;</span><span class=\"tag\">&lt;<span class=\"name\">input</span> <span class=\"attr\">id</span>=<span class=\"string\">\"userId\"</span> <span class=\"attr\">name</span>=<span class=\"string\">\"userId\"</span> <span class=\"attr\">type</span>=<span class=\"string\">\"text\"</span> <span class=\"attr\">value</span>=<span class=\"string\">\"10\"</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">div</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">p</span>&gt;</span>【toUserId】：</span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">div</span>&gt;</span><span class=\"tag\">&lt;<span class=\"name\">input</span> <span class=\"attr\">id</span>=<span class=\"string\">\"toUserId\"</span> <span class=\"attr\">name</span>=<span class=\"string\">\"toUserId\"</span> <span class=\"attr\">type</span>=<span class=\"string\">\"text\"</span> <span class=\"attr\">value</span>=<span class=\"string\">\"20\"</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">div</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">p</span>&gt;</span>【toUserId】：</span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">div</span>&gt;</span><span class=\"tag\">&lt;<span class=\"name\">input</span> <span class=\"attr\">id</span>=<span class=\"string\">\"contentText\"</span> <span class=\"attr\">name</span>=<span class=\"string\">\"contentText\"</span> <span class=\"attr\">type</span>=<span class=\"string\">\"text\"</span> <span class=\"attr\">value</span>=<span class=\"string\">\"hello websocket\"</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">div</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">p</span>&gt;</span>【操作】：</span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">div</span>&gt;</span><span class=\"tag\">&lt;<span class=\"name\">a</span> <span class=\"attr\">onclick</span>=<span class=\"string\">\"openSocket()\"</span>&gt;</span>开启socket<span class=\"tag\">&lt;/<span class=\"name\">a</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">div</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">p</span>&gt;</span>【操作】：</span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">div</span>&gt;</span><span class=\"tag\">&lt;<span class=\"name\">a</span> <span class=\"attr\">onclick</span>=<span class=\"string\">\"sendMessage()\"</span>&gt;</span>发送消息<span class=\"tag\">&lt;/<span class=\"name\">a</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">div</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">body</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">html</span>&gt;</span></span><br></pre></td></tr></table></figure>","next":{"title":"Ubuntu系统安装easyconnect","path":"api/articles/resource-system-Linux-ubuntu-easyconnect.json","image":"/img/header_img/15.gif","num_read":1295,"num_like":162,"num_collection":621,"num_comments":182},"prev":{"title":"MySQL常见异常","path":"api/articles/resource-DB-MySQL-MySQl-error.json","image":"/img/header_img/DB/mysql.jpg","num_read":1810,"num_like":630,"num_collection":29,"num_comments":91},"categories":[{"name":"Spring全家桶","path":"api/categories/Spring全家桶.json","pathContent":"api/categories/Spring全家桶","description":"更快、更容易、更安全","cover":"https://sunfy9.gitee.io/project/photo/project/spring.png"}],"tags":[{"name":"SpringBoot","path":"api/tags/SpringBoot.json","pathContent":"api/tags/SpringBoot","description":"更快、更容易、更安全","cover":"https://sunfy9.gitee.io/project/photo/project/spring.png"},{"name":"WebSocket","path":"api/tags/WebSocket.json","pathContent":"api/tags/WebSocket","description":"[WebSocket]暂未设置说明","cover":"https://sunfy9.gitee.io/img/header_img/sunfy-default.png"}]}