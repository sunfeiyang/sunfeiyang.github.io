{"title":"SQLSERVER数据库查询执行效率、锁表等情况","num_read":1783,"num_like":806,"num_collection":696,"num_comments":64,"slug":"resource-DB-SQLServer-查询执行效率、锁表等情况","date":"2022-06-01T16:00:00.000Z","img":"/img/header_img/DB/Executionefficiency.png","format":"max","_id":"clhrbp2ay002io5lg4w6p27j9","project":"DB","subtitle":"执行效率、锁表","hot":"read","site":{"data":{}},"updated":"2022-08-05T04:18:04.000Z","comments":true,"path":"api/articles/resource-DB-SQLServer-查询执行效率、锁表等情况.json","webPath":"2022/06/02/resource-DB-SQLServer-查询执行效率、锁表等情况/","permalink":"https://sunfy9.gitee.io/2022/06/02/resource-DB-SQLServer-%E6%9F%A5%E8%AF%A2%E6%89%A7%E8%A1%8C%E6%95%88%E7%8E%87%E3%80%81%E9%94%81%E8%A1%A8%E7%AD%89%E6%83%85%E5%86%B5/","excerpt":null,"covers":null,"keywords":"sunfy, hexo-theme-snail","content":"<h5 id=\"sql执行效率\"><a href=\"#sql执行效率\" class=\"headerlink\" title=\"sql执行效率\"></a>sql执行效率</h5><figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">SELECT</span> TOP <span class=\"number\">50</span> qs.total_worker_time / qs.execution_count <span class=\"keyword\">as</span> [<span class=\"keyword\">Avg</span> CPU <span class=\"built_in\">Time</span>],</span><br><span class=\"line\">    <span class=\"keyword\">SUBSTRING</span>(qt.text, qs.statement_start_offset / <span class=\"number\">2</span>,</span><br><span class=\"line\">              (<span class=\"keyword\">case</span></span><br><span class=\"line\">                   <span class=\"keyword\">when</span> qs.statement_end_offset = <span class=\"number\">-1</span></span><br><span class=\"line\">                       <span class=\"keyword\">then</span> <span class=\"keyword\">len</span>(<span class=\"keyword\">convert</span>(<span class=\"keyword\">nvarchar</span>(<span class=\"keyword\">max</span>), qt.text)) * <span class=\"number\">2</span></span><br><span class=\"line\">                   <span class=\"keyword\">else</span> qs.statement_end_offset <span class=\"keyword\">end</span> - qs.statement_start_offset) / <span class=\"number\">2</span>)</span><br><span class=\"line\">                                                        <span class=\"keyword\">as</span> query_text,</span><br><span class=\"line\">    qt.dbid,</span><br><span class=\"line\">              dbname=db_name(qt.dbid),</span><br><span class=\"line\">    qt.objectid</span><br><span class=\"line\"><span class=\"keyword\">FROM</span> sys.dm_exec_query_stats qs</span><br><span class=\"line\">         <span class=\"keyword\">cross</span> <span class=\"keyword\">apply</span> sys.dm_exec_sql_text(qs.sql_handle) <span class=\"keyword\">as</span> qt</span><br><span class=\"line\"><span class=\"keyword\">ORDER</span> <span class=\"keyword\">BY</span> [<span class=\"keyword\">Avg</span> CPU <span class=\"built_in\">Time</span>] <span class=\"keyword\">DESC</span></span><br></pre></td></tr></table></figure>\n<h5 id=\"SQLServer-查看耗时较多的SQL语句\"><a href=\"#SQLServer-查看耗时较多的SQL语句\" class=\"headerlink\" title=\"SQLServer 查看耗时较多的SQL语句\"></a>SQLServer 查看耗时较多的SQL语句<sunfy-line></h5><figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">SELECT</span> TOP <span class=\"number\">20</span> </span><br><span class=\"line\">    total_worker_time/<span class=\"number\">1000</span> <span class=\"keyword\">AS</span> [总消耗CPU 时间(ms)],execution_count [运行次数],</span><br><span class=\"line\">   qs.total_worker_time/qs.execution_count/<span class=\"number\">1000</span> <span class=\"keyword\">AS</span> [平均消耗CPU 时间(ms)],</span><br><span class=\"line\">    last_execution_time <span class=\"keyword\">AS</span> [最后一次执行时间],</span><br><span class=\"line\">    max_worker_time /<span class=\"number\">1000</span> <span class=\"keyword\">AS</span> [最大执行时间(ms)],</span><br><span class=\"line\">    <span class=\"keyword\">SUBSTRING</span>(qt.text,qs.statement_start_offset/<span class=\"number\">2</span>+<span class=\"number\">1</span>,</span><br><span class=\"line\">        (<span class=\"keyword\">CASE</span> <span class=\"keyword\">WHEN</span> qs.statement_end_offset = <span class=\"number\">-1</span> </span><br><span class=\"line\">            <span class=\"keyword\">THEN</span> <span class=\"keyword\">DATALENGTH</span>(qt.text) </span><br><span class=\"line\">            <span class=\"keyword\">ELSE</span> qs.statement_end_offset <span class=\"keyword\">END</span> -qs.statement_start_offset)/<span class=\"number\">2</span> + <span class=\"number\">1</span>)</span><br><span class=\"line\">        <span class=\"keyword\">AS</span> [使用CPU的语法], qt.text [完整语法],</span><br><span class=\"line\">              dbname=db_name(qt.dbid),</span><br><span class=\"line\">              object_name(qt.objectid,qt.dbid) ObjectName</span><br><span class=\"line\"><span class=\"keyword\">FROM</span> sys.dm_exec_query_stats qs <span class=\"keyword\">WITH</span>(nolock)</span><br><span class=\"line\"><span class=\"keyword\">CROSS</span> <span class=\"keyword\">apply</span> sys.dm_exec_sql_text(qs.sql_handle) <span class=\"keyword\">AS</span> qt</span><br><span class=\"line\"><span class=\"keyword\">WHERE</span> execution_count&gt;<span class=\"number\">1</span></span><br><span class=\"line\"><span class=\"keyword\">ORDER</span> <span class=\"keyword\">BY</span>  total_worker_time <span class=\"keyword\">DESC</span></span><br></pre></td></tr></table></figure>\n<h5 id=\"查询-某个时间段内比较耗时-的SQL\"><a href=\"#查询-某个时间段内比较耗时-的SQL\" class=\"headerlink\" title=\"查询 某个时间段内比较耗时 的SQL\"></a>查询 某个时间段内比较耗时 的SQL</h5><figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">SELECT</span> TOP <span class=\"number\">1000</span> </span><br><span class=\"line\">       ST.text <span class=\"keyword\">AS</span> <span class=\"string\">'执行的SQL语句'</span>,</span><br><span class=\"line\">       QS.execution_count <span class=\"keyword\">AS</span> <span class=\"string\">'执行次数'</span>,</span><br><span class=\"line\">       QS.total_elapsed_time/<span class=\"number\">1000</span> <span class=\"keyword\">AS</span> <span class=\"string\">'耗时'</span>,<span class=\"comment\">--ms</span></span><br><span class=\"line\">       QS.last_worker_time <span class=\"keyword\">AS</span> <span class=\"string\">'12'</span>,</span><br><span class=\"line\">       QS.total_logical_reads <span class=\"keyword\">AS</span> <span class=\"string\">'逻辑读取次数'</span>,</span><br><span class=\"line\">       QS.total_logical_writes <span class=\"keyword\">AS</span> <span class=\"string\">'逻辑写入次数'</span>,</span><br><span class=\"line\">       QS.total_physical_reads <span class=\"keyword\">AS</span> <span class=\"string\">'物理读取次数'</span>,       </span><br><span class=\"line\">       QS.creation_time <span class=\"keyword\">AS</span> <span class=\"string\">'执行时间'</span> ,  </span><br><span class=\"line\">       QS.*</span><br><span class=\"line\"><span class=\"keyword\">FROM</span>   sys.dm_exec_query_stats QS</span><br><span class=\"line\">       <span class=\"keyword\">CROSS</span> <span class=\"keyword\">APPLY</span> </span><br><span class=\"line\">sys.dm_exec_sql_text(QS.sql_handle) ST</span><br><span class=\"line\"><span class=\"keyword\">WHERE</span>  QS.creation_time <span class=\"keyword\">BETWEEN</span> <span class=\"string\">'2017-05-08 12:50:00'</span> <span class=\"keyword\">AND</span> <span class=\"string\">'2017-05-09 17:10:00'</span> </span><br><span class=\"line\"><span class=\"keyword\">ORDER</span> <span class=\"keyword\">BY</span>  QS.total_elapsed_time <span class=\"keyword\">DESC</span></span><br></pre></td></tr></table></figure>\n<h5 id=\"执行最慢的SQL语句（全部sql执行时间列表）\"><a href=\"#执行最慢的SQL语句（全部sql执行时间列表）\" class=\"headerlink\" title=\"执行最慢的SQL语句（全部sql执行时间列表）\"></a>执行最慢的SQL语句（全部sql执行时间列表）</h5><figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">SELECT</span> (total_elapsed_time / execution_count) / <span class=\"number\">1000</span>        N<span class=\"string\">'平均时间ms'</span></span><br><span class=\"line\">     , total_elapsed_time / <span class=\"number\">1000</span>                            N<span class=\"string\">'总花费时间ms'</span></span><br><span class=\"line\">     , total_worker_time / <span class=\"number\">1000</span>                             N<span class=\"string\">'所用的CPU总时间ms'</span></span><br><span class=\"line\">     , total_physical_reads                                 N<span class=\"string\">'物理读取总次数'</span></span><br><span class=\"line\">     , total_logical_reads / execution_count                N<span class=\"string\">'每次逻辑读次数'</span></span><br><span class=\"line\">     , total_logical_reads                                  N<span class=\"string\">'逻辑读取总次数'</span></span><br><span class=\"line\">     , total_logical_writes                                 N<span class=\"string\">'逻辑写入总次数'</span></span><br><span class=\"line\">     , execution_count                                      N<span class=\"string\">'执行次数'</span></span><br><span class=\"line\">     , <span class=\"keyword\">SUBSTRING</span>(st.text, (qs.statement_start_offset / <span class=\"number\">2</span>) + <span class=\"number\">1</span>,</span><br><span class=\"line\">                 ((<span class=\"keyword\">CASE</span> statement_end_offset</span><br><span class=\"line\">                       <span class=\"keyword\">WHEN</span> <span class=\"number\">-1</span> <span class=\"keyword\">THEN</span> <span class=\"keyword\">DATALENGTH</span>(st.text)</span><br><span class=\"line\">                       <span class=\"keyword\">ELSE</span> qs.statement_end_offset <span class=\"keyword\">END</span></span><br><span class=\"line\">                     - qs.statement_start_offset) / <span class=\"number\">2</span>) + <span class=\"number\">1</span>) N<span class=\"string\">'执行语句'</span></span><br><span class=\"line\">     , creation_time                                        N<span class=\"string\">'语句编译时间'</span></span><br><span class=\"line\">     , last_execution_time                                  N<span class=\"string\">'上次执行时间'</span></span><br><span class=\"line\"><span class=\"keyword\">FROM</span> sys.dm_exec_query_stats <span class=\"keyword\">AS</span> qs</span><br><span class=\"line\">         <span class=\"keyword\">CROSS</span> <span class=\"keyword\">APPLY</span> sys.dm_exec_sql_text(qs.sql_handle) st</span><br><span class=\"line\"><span class=\"keyword\">WHERE</span> <span class=\"keyword\">SUBSTRING</span>(st.text, (qs.statement_start_offset / <span class=\"number\">2</span>) + <span class=\"number\">1</span>,</span><br><span class=\"line\">                ((<span class=\"keyword\">CASE</span> statement_end_offset</span><br><span class=\"line\">                      <span class=\"keyword\">WHEN</span> <span class=\"number\">-1</span> <span class=\"keyword\">THEN</span> <span class=\"keyword\">DATALENGTH</span>(st.text)</span><br><span class=\"line\">                      <span class=\"keyword\">ELSE</span> qs.statement_end_offset <span class=\"keyword\">END</span></span><br><span class=\"line\">                    - qs.statement_start_offset) / <span class=\"number\">2</span>) + <span class=\"number\">1</span>) <span class=\"keyword\">not</span> <span class=\"keyword\">like</span> <span class=\"string\">'�tch%'</span></span><br><span class=\"line\"><span class=\"keyword\">ORDER</span> <span class=\"keyword\">BY</span> total_elapsed_time / execution_count <span class=\"keyword\">DESC</span>;</span><br></pre></td></tr></table></figure>\n<h5 id=\"查找逻辑读取最高的查询-存储过程\"><a href=\"#查找逻辑读取最高的查询-存储过程\" class=\"headerlink\" title=\"查找逻辑读取最高的查询(存储过程)\"></a>查找逻辑读取最高的查询(存储过程)</h5><figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">SELECT</span> TOP ( <span class=\"number\">25</span> )</span><br><span class=\"line\">        P.name <span class=\"keyword\">AS</span> [SP <span class=\"keyword\">Name</span>] ,</span><br><span class=\"line\">        Deps.total_logical_reads <span class=\"keyword\">AS</span> [TotalLogicalReads] ,</span><br><span class=\"line\">        deps.total_logical_reads / deps.execution_count <span class=\"keyword\">AS</span> [AvgLogicalReads] ,</span><br><span class=\"line\">        deps.execution_count ,</span><br><span class=\"line\">        <span class=\"keyword\">ISNULL</span>(deps.execution_count / <span class=\"keyword\">DATEDIFF</span>(<span class=\"keyword\">Second</span>, deps.cached_time,</span><br><span class=\"line\">                                               <span class=\"keyword\">GETDATE</span>()), <span class=\"number\">0</span>) <span class=\"keyword\">AS</span> [Calls/<span class=\"keyword\">Second</span>] ,</span><br><span class=\"line\">        deps.total_elapsed_time ,</span><br><span class=\"line\">        deps.total_elapsed_time / deps.execution_count <span class=\"keyword\">AS</span> [avg_elapsed_time] ,</span><br><span class=\"line\">        deps.cached_time</span><br><span class=\"line\"><span class=\"keyword\">FROM</span>    sys.procedures <span class=\"keyword\">AS</span> p</span><br><span class=\"line\">        <span class=\"keyword\">INNER</span> <span class=\"keyword\">JOIN</span> sys.dm_exec_procedure_stats <span class=\"keyword\">AS</span> deps <span class=\"keyword\">ON</span> p.[Object_id] = deps.[Object_id]</span><br><span class=\"line\"><span class=\"keyword\">WHERE</span>   deps.Database_id = DB_ID()</span><br><span class=\"line\"><span class=\"keyword\">ORDER</span> <span class=\"keyword\">BY</span> deps.total_logical_reads <span class=\"keyword\">DESC</span>;</span><br></pre></td></tr></table></figure>\n<h5 id=\"查询CPU最高的10条SQL\"><a href=\"#查询CPU最高的10条SQL\" class=\"headerlink\" title=\"查询CPU最高的10条SQL\"></a>查询CPU最高的10条SQL</h5><figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">SELECT</span> TOP <span class=\"number\">10</span> <span class=\"built_in\">TEXT</span>                                                                                  <span class=\"keyword\">AS</span> <span class=\"string\">'SQL Statement'</span></span><br><span class=\"line\">            , last_execution_time                                                                   <span class=\"keyword\">AS</span> <span class=\"string\">'Last Execution Time'</span></span><br><span class=\"line\">            , (total_logical_reads + total_physical_reads + total_logical_writes) / execution_count <span class=\"keyword\">AS</span> [Average IO]</span><br><span class=\"line\">            , (total_worker_time / execution_count) / <span class=\"number\">1000000.0</span>                                     <span class=\"keyword\">AS</span> [Average CPU <span class=\"built_in\">Time</span> (sec)]</span><br><span class=\"line\">            , (total_elapsed_time / execution_count) / <span class=\"number\">1000000.0</span>                                    <span class=\"keyword\">AS</span> [Average Elapsed <span class=\"built_in\">Time</span> (sec)]</span><br><span class=\"line\">            , execution_count                                                                       <span class=\"keyword\">AS</span> <span class=\"string\">\"Execution Count\"</span></span><br><span class=\"line\">            , qs.total_physical_reads</span><br><span class=\"line\">            , qs.total_logical_writes</span><br><span class=\"line\">            , qp.query_plan                                                                         <span class=\"keyword\">AS</span> <span class=\"string\">\"Query Plan\"</span></span><br><span class=\"line\"><span class=\"keyword\">FROM</span> sys.dm_exec_query_stats qs</span><br><span class=\"line\">         <span class=\"keyword\">CROSS</span> <span class=\"keyword\">APPLY</span> sys.dm_exec_sql_text(qs.plan_handle) st</span><br><span class=\"line\">         <span class=\"keyword\">CROSS</span> <span class=\"keyword\">APPLY</span> sys.dm_exec_query_plan(qs.plan_handle) qp</span><br><span class=\"line\"><span class=\"keyword\">ORDER</span> <span class=\"keyword\">BY</span> total_elapsed_time / execution_count <span class=\"keyword\">DESC</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">-------------------------方式二：有中文列名称-------------------------------------</span></span><br><span class=\"line\"><span class=\"keyword\">SELECT</span> TOP <span class=\"number\">20</span></span><br><span class=\"line\">    total_worker_time/<span class=\"number\">1000</span> <span class=\"keyword\">AS</span> [总消耗CPU 时间(ms)],execution_count [运行次数],</span><br><span class=\"line\">    qs.total_worker_time/qs.execution_count/<span class=\"number\">1000</span> <span class=\"keyword\">AS</span> [平均消耗CPU 时间(ms)],</span><br><span class=\"line\">    last_execution_time <span class=\"keyword\">AS</span> [最后一次执行时间],max_worker_time /<span class=\"number\">1000</span> <span class=\"keyword\">AS</span> [最大执行时间(ms)],</span><br><span class=\"line\">    <span class=\"keyword\">SUBSTRING</span>(qt.text,qs.statement_start_offset/<span class=\"number\">2</span>+<span class=\"number\">1</span>,</span><br><span class=\"line\">        (<span class=\"keyword\">CASE</span> <span class=\"keyword\">WHEN</span> qs.statement_end_offset = <span class=\"number\">-1</span></span><br><span class=\"line\">        <span class=\"keyword\">THEN</span> <span class=\"keyword\">DATALENGTH</span>(qt.text)</span><br><span class=\"line\">        <span class=\"keyword\">ELSE</span> qs.statement_end_offset <span class=\"keyword\">END</span> -qs.statement_start_offset)/<span class=\"number\">2</span> + <span class=\"number\">1</span>)</span><br><span class=\"line\">    <span class=\"keyword\">AS</span> [使用CPU的语法], qt.text [完整语法],</span><br><span class=\"line\">    qt.dbid, dbname=db_name(qt.dbid),</span><br><span class=\"line\">    qt.objectid,object_name(qt.objectid,qt.dbid) ObjectName</span><br><span class=\"line\"><span class=\"keyword\">FROM</span> sys.dm_exec_query_stats qs <span class=\"keyword\">WITH</span>(nolock)</span><br><span class=\"line\"><span class=\"keyword\">CROSS</span> <span class=\"keyword\">apply</span> sys.dm_exec_sql_text(qs.sql_handle) <span class=\"keyword\">AS</span> qt</span><br><span class=\"line\"><span class=\"keyword\">WHERE</span> execution_count&gt;<span class=\"number\">1</span></span><br><span class=\"line\"><span class=\"keyword\">ORDER</span> <span class=\"keyword\">BY</span>  total_worker_time <span class=\"keyword\">DESC</span></span><br></pre></td></tr></table></figure>\n<h5 id=\"找出执行频繁的语句的SQL语句\"><a href=\"#找出执行频繁的语句的SQL语句\" class=\"headerlink\" title=\"找出执行频繁的语句的SQL语句\"></a>找出执行频繁的语句的SQL语句</h5><figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">with</span> aa <span class=\"keyword\">as</span> (</span><br><span class=\"line\">    <span class=\"keyword\">SELECT</span></span><br><span class=\"line\"><span class=\"comment\">--执行次数 </span></span><br><span class=\"line\">QS.execution_count,</span><br><span class=\"line\"><span class=\"comment\">--查询语句 </span></span><br><span class=\"line\"><span class=\"keyword\">SUBSTRING</span>(ST.text, (QS.statement_start_offset / <span class=\"number\">2</span>) + <span class=\"number\">1</span>,</span><br><span class=\"line\">          ((<span class=\"keyword\">CASE</span> QS.statement_end_offset</span><br><span class=\"line\">                <span class=\"keyword\">WHEN</span> <span class=\"number\">-1</span> <span class=\"keyword\">THEN</span> <span class=\"keyword\">DATALENGTH</span>(st.text)</span><br><span class=\"line\">                <span class=\"keyword\">ELSE</span> QS.statement_end_offset <span class=\"keyword\">END</span> - QS.statement_start_offset) / <span class=\"number\">2</span>) + <span class=\"number\">1</span></span><br><span class=\"line\">    ) <span class=\"keyword\">AS</span> statement_text,</span><br><span class=\"line\"><span class=\"comment\">--执行文本 </span></span><br><span class=\"line\">ST.text,</span><br><span class=\"line\"><span class=\"comment\">--执行计划 </span></span><br><span class=\"line\">qs.last_elapsed_time,</span><br><span class=\"line\">qs.min_elapsed_time,</span><br><span class=\"line\">qs.max_elapsed_time,</span><br><span class=\"line\">QS.total_worker_time,</span><br><span class=\"line\">QS.last_worker_time,</span><br><span class=\"line\">QS.max_worker_time,</span><br><span class=\"line\">QS.min_worker_time</span><br><span class=\"line\">    <span class=\"keyword\">FROM</span> sys.dm_exec_query_stats QS</span><br><span class=\"line\"><span class=\"comment\">--关键字 </span></span><br><span class=\"line\">             <span class=\"keyword\">CROSS</span> <span class=\"keyword\">APPLY</span></span><br><span class=\"line\">         sys.dm_exec_sql_text(QS.sql_handle) ST</span><br><span class=\"line\">    <span class=\"keyword\">WHERE</span> QS.last_execution_time &gt; <span class=\"string\">'2016-02-14 00:00:00'</span></span><br><span class=\"line\">      <span class=\"keyword\">and</span> execution_count &gt; <span class=\"number\">500</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">-- AND ST.text LIKE '%%' </span></span><br><span class=\"line\"><span class=\"comment\">--ORDER BY </span></span><br><span class=\"line\"><span class=\"comment\">--QS.execution_count DESC</span></span><br><span class=\"line\"></span><br><span class=\"line\">)</span><br><span class=\"line\"><span class=\"keyword\">select</span> <span class=\"built_in\">text</span>,</span><br><span class=\"line\">       <span class=\"keyword\">max</span>(execution_count) execution_count <span class=\"comment\">--,last_elapsed_time,min_elapsed_time,max_elapsed_time </span></span><br><span class=\"line\"><span class=\"keyword\">from</span> aa</span><br><span class=\"line\"><span class=\"keyword\">where</span> [<span class=\"built_in\">text</span>] <span class=\"keyword\">not</span> <span class=\"keyword\">like</span> <span class=\"string\">'%sp_MSupd_%'</span></span><br><span class=\"line\">  <span class=\"keyword\">and</span> [<span class=\"built_in\">text</span>] <span class=\"keyword\">not</span> <span class=\"keyword\">like</span> <span class=\"string\">'%sp_MSins_%'</span></span><br><span class=\"line\">  <span class=\"keyword\">and</span> [<span class=\"built_in\">text</span>] <span class=\"keyword\">not</span> <span class=\"keyword\">like</span> <span class=\"string\">'%sp_MSdel_%'</span></span><br><span class=\"line\"><span class=\"keyword\">group</span> <span class=\"keyword\">by</span> <span class=\"built_in\">text</span></span><br><span class=\"line\"><span class=\"keyword\">order</span> <span class=\"keyword\">by</span> <span class=\"number\">2</span> <span class=\"keyword\">desc</span></span><br></pre></td></tr></table></figure>\n<h5 id=\"查询当前锁定的表-锁等待\"><a href=\"#查询当前锁定的表-锁等待\" class=\"headerlink\" title=\"查询当前锁定的表(锁等待)\"></a>查询当前锁定的表(锁等待)</h5><figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">select</span> request_session_id spid, OBJECT_NAME(resource_associated_entity_id) tableName</span><br><span class=\"line\"><span class=\"keyword\">from</span> sys.dm_tran_locks</span><br><span class=\"line\"><span class=\"keyword\">where</span> resource_type = <span class=\"string\">'OBJECT'</span></span><br></pre></td></tr></table></figure>\n<h5 id=\"查询到锁表后进行杀死\"><a href=\"#查询到锁表后进行杀死\" class=\"headerlink\" title=\"查询到锁表后进行杀死\"></a>查询到锁表后进行杀死</h5><figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">declare</span></span><br><span class=\"line\">    @spid <span class=\"built_in\">int</span></span><br><span class=\"line\"><span class=\"keyword\">Set</span> @spid = <span class=\"number\">51</span> <span class=\"comment\">--锁表进程</span></span><br><span class=\"line\"><span class=\"keyword\">declare</span></span><br><span class=\"line\">    @<span class=\"keyword\">sql</span> <span class=\"built_in\">varchar</span>(<span class=\"number\">1000</span>)</span><br><span class=\"line\"><span class=\"keyword\">set</span> @<span class=\"keyword\">sql</span> = <span class=\"string\">'kill '</span> + <span class=\"keyword\">cast</span>(@spid <span class=\"keyword\">as</span> <span class=\"built_in\">varchar</span>)</span><br><span class=\"line\">exec (@<span class=\"keyword\">sql</span>)</span><br></pre></td></tr></table></figure>\n<h5 id=\"查询SqlServer总体的内存使用情况\"><a href=\"#查询SqlServer总体的内存使用情况\" class=\"headerlink\" title=\"查询SqlServer总体的内存使用情况\"></a>查询SqlServer总体的内存使用情况</h5><figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">-- 查询SqlServer总体的内存使用情况</span></span><br><span class=\"line\"><span class=\"keyword\">select</span>      <span class=\"keyword\">type</span></span><br><span class=\"line\">        , <span class=\"keyword\">sum</span>(virtual_memory_reserved_kb) VM_Reserved</span><br><span class=\"line\">        , <span class=\"keyword\">sum</span>(virtual_memory_committed_kb) VM_Commited</span><br><span class=\"line\">        , <span class=\"keyword\">sum</span>(awe_allocated_kb) AWE_Allocated</span><br><span class=\"line\">        , <span class=\"keyword\">sum</span>(shared_memory_reserved_kb) Shared_Reserved</span><br><span class=\"line\">        , <span class=\"keyword\">sum</span>(shared_memory_committed_kb) Shared_Commited</span><br><span class=\"line\">        <span class=\"comment\">--, sum(single_pages_kb)    --SQL2005、2008</span></span><br><span class=\"line\">        <span class=\"comment\">--, sum(multi_pages_kb)        --SQL2005、2008</span></span><br><span class=\"line\"><span class=\"keyword\">from</span>    sys.dm_os_memory_clerks</span><br><span class=\"line\"><span class=\"keyword\">group</span> <span class=\"keyword\">by</span> <span class=\"keyword\">type</span></span><br><span class=\"line\"><span class=\"keyword\">order</span> <span class=\"keyword\">by</span> <span class=\"keyword\">type</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">-- 查询当前数据库缓存的所有数据页面，哪些数据表，缓存的数据页面数量</span></span><br><span class=\"line\"><span class=\"comment\">-- 从这些信息可以看出，系统经常要访问的都是哪些表，有多大？</span></span><br><span class=\"line\"><span class=\"keyword\">select</span> p.object_id, object_name=object_name(p.object_id), p.index_id, buffer_pages=<span class=\"keyword\">count</span>(*) </span><br><span class=\"line\"><span class=\"keyword\">from</span> sys.allocation_units a, </span><br><span class=\"line\">    sys.dm_os_buffer_descriptors b, </span><br><span class=\"line\">    sys.partitions p </span><br><span class=\"line\"><span class=\"keyword\">where</span> a.allocation_unit_id=b.allocation_unit_id </span><br><span class=\"line\">    <span class=\"keyword\">and</span> a.container_id=p.hobt_id </span><br><span class=\"line\">    <span class=\"keyword\">and</span> b.database_id=db_id()</span><br><span class=\"line\"><span class=\"keyword\">group</span> <span class=\"keyword\">by</span> p.object_id,p.index_id </span><br><span class=\"line\"><span class=\"keyword\">order</span> <span class=\"keyword\">by</span> buffer_pages <span class=\"keyword\">desc</span> </span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">-- 查询缓存的各类执行计划，及分别占了多少内存</span></span><br><span class=\"line\"><span class=\"comment\">-- 可以对比动态查询与参数化SQL（预定义语句）的缓存量</span></span><br><span class=\"line\"><span class=\"keyword\">select</span>    cacheobjtype</span><br><span class=\"line\">        , objtype</span><br><span class=\"line\">        , <span class=\"keyword\">sum</span>(<span class=\"keyword\">cast</span>(size_in_bytes <span class=\"keyword\">as</span> <span class=\"built_in\">bigint</span>))/<span class=\"number\">1024</span> <span class=\"keyword\">as</span> size_in_kb</span><br><span class=\"line\">        , <span class=\"keyword\">count</span>(bucketid) <span class=\"keyword\">as</span> cache_count</span><br><span class=\"line\"><span class=\"keyword\">from</span>    sys.dm_exec_cached_plans</span><br><span class=\"line\"><span class=\"keyword\">group</span> <span class=\"keyword\">by</span> cacheobjtype, objtype</span><br><span class=\"line\"><span class=\"keyword\">order</span> <span class=\"keyword\">by</span> cacheobjtype, objtype</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">-- 查询缓存中具体的执行计划，及对应的SQL</span></span><br><span class=\"line\"><span class=\"comment\">-- 将此结果按照数据表或SQL进行统计，可以作为基线，调整索引时考虑</span></span><br><span class=\"line\"><span class=\"comment\">-- 查询结果会很大，注意将结果集输出到表或文件中</span></span><br><span class=\"line\"><span class=\"keyword\">SELECT</span>  usecounts ,</span><br><span class=\"line\">        refcounts ,</span><br><span class=\"line\">        size_in_bytes ,</span><br><span class=\"line\">        cacheobjtype ,</span><br><span class=\"line\">        objtype ,</span><br><span class=\"line\">        <span class=\"built_in\">TEXT</span></span><br><span class=\"line\"><span class=\"keyword\">FROM</span>    sys.dm_exec_cached_plans cp</span><br><span class=\"line\">        <span class=\"keyword\">CROSS</span> <span class=\"keyword\">APPLY</span> sys.dm_exec_sql_text(plan_handle)</span><br><span class=\"line\"><span class=\"keyword\">ORDER</span> <span class=\"keyword\">BY</span> objtype <span class=\"keyword\">DESC</span> ;</span><br><span class=\"line\">GO</span><br></pre></td></tr></table></figure>\n<h5 id=\"使用SQL语句设置SQLserver内存分配\"><a href=\"#使用SQL语句设置SQLserver内存分配\" class=\"headerlink\" title=\"使用SQL语句设置SQLserver内存分配\"></a>使用SQL语句设置SQLserver内存分配</h5><figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">-- 1.使用SQL语句设置SQLserver内存分配：</span></span><br><span class=\"line\"><span class=\"comment\">-- a.配置最小内存</span></span><br><span class=\"line\"><span class=\"comment\">--将最小内存设置为0MB</span></span><br><span class=\"line\">exec sp_configure N'min server memory (MB) ',16</span><br><span class=\"line\"><span class=\"comment\">--b.配置最大内存</span></span><br><span class=\"line\"><span class=\"comment\">--将最大内存设置为256MB</span></span><br><span class=\"line\">exec sp_configure N'max server memory (MB)',266 </span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">--执行结果：</span></span><br><span class=\"line\"><span class=\"comment\">--配置选项 'min server memory (MB)' 已从 14 更改为 16。请运行 RECONFIGURE 语句进行安装。</span></span><br><span class=\"line\"><span class=\"comment\">--配置选项 'max server memory (MB)' 已从 444 更改为 266。请运行 RECONFIGURE 语句进行安装。</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">--最后执行下面语句进行安装</span></span><br><span class=\"line\">reconfigure <span class=\"keyword\">with</span> override</span><br><span class=\"line\"><span class=\"comment\">--执行结果：</span></span><br><span class=\"line\">命令已成功完成。</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">--系统服务日志：</span></span><br><span class=\"line\">配置选项 <span class=\"string\">'min server memory (MB)'</span> 已从 <span class=\"number\">14</span> 更改为 <span class=\"number\">16</span>。请运行 RECONFIGURE 语句进行安装。</span><br><span class=\"line\">配置选项 <span class=\"string\">'max server memory (MB)'</span> 已从 <span class=\"number\">444</span> 更改为 <span class=\"number\">266</span>。请运行 RECONFIGURE 语句进行安装。</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">--2.手动操作设置</span></span><br><span class=\"line\"><span class=\"comment\">--右击本地服务器--&gt;服务器属性--&gt;内存 设置完，单击确定即可。</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">一般设置完后，最好将该<span class=\"keyword\">SQL</span>服务重启下。</span><br></pre></td></tr></table></figure>\n<h5 id=\"查询SQLSERVER执行过的SQL记录\"><a href=\"#查询SQLSERVER执行过的SQL记录\" class=\"headerlink\" title=\"查询SQLSERVER执行过的SQL记录\"></a>查询SQLSERVER执行过的SQL记录</h5><figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">仅支持SQL SERVER2008及以上版本</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">SELECT</span> TOP <span class=\"number\">1000</span></span><br><span class=\"line\"><span class=\"comment\">--创建时间</span></span><br><span class=\"line\">QS.creation_time,</span><br><span class=\"line\"><span class=\"comment\">--查询语句</span></span><br><span class=\"line\"><span class=\"keyword\">SUBSTRING</span>(ST.text,(QS.statement_start_offset/<span class=\"number\">2</span>)+<span class=\"number\">1</span>,</span><br><span class=\"line\">((<span class=\"keyword\">CASE</span> QS.statement_end_offset <span class=\"keyword\">WHEN</span> <span class=\"number\">-1</span> <span class=\"keyword\">THEN</span> <span class=\"keyword\">DATALENGTH</span>(st.text)</span><br><span class=\"line\"><span class=\"keyword\">ELSE</span> QS.statement_end_offset <span class=\"keyword\">END</span> - QS.statement_start_offset)/<span class=\"number\">2</span>) + <span class=\"number\">1</span></span><br><span class=\"line\">) <span class=\"keyword\">AS</span> statement_text,</span><br><span class=\"line\"><span class=\"comment\">--执行文本</span></span><br><span class=\"line\">ST.text,</span><br><span class=\"line\"><span class=\"comment\">--执行计划</span></span><br><span class=\"line\">QS.total_worker_time,</span><br><span class=\"line\">QS.last_worker_time,</span><br><span class=\"line\">QS.max_worker_time,</span><br><span class=\"line\">QS.min_worker_time</span><br><span class=\"line\"><span class=\"keyword\">FROM</span></span><br><span class=\"line\">sys.dm_exec_query_stats QS</span><br><span class=\"line\"><span class=\"comment\">--关键字</span></span><br><span class=\"line\"><span class=\"keyword\">CROSS</span> <span class=\"keyword\">APPLY</span></span><br><span class=\"line\">sys.dm_exec_sql_text(QS.sql_handle) ST</span><br><span class=\"line\"><span class=\"keyword\">WHERE</span></span><br><span class=\"line\">QS.creation_time <span class=\"keyword\">BETWEEN</span> <span class=\"string\">'2018-05-08 09:00:00'</span> <span class=\"keyword\">AND</span> <span class=\"string\">'2018-05-08 18:00:00'</span></span><br><span class=\"line\">–<span class=\"keyword\">AND</span> ST.text <span class=\"keyword\">LIKE</span> <span class=\"string\">'%%'</span></span><br><span class=\"line\"><span class=\"keyword\">ORDER</span> <span class=\"keyword\">BY</span></span><br><span class=\"line\">QS.creation_time <span class=\"keyword\">DESC</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">SELECT</span> TOP <span class=\"number\">1000</span></span><br><span class=\"line\"><span class=\"comment\">--创建时间</span></span><br><span class=\"line\">QS.creation_time,</span><br><span class=\"line\"><span class=\"comment\">--执行文本</span></span><br><span class=\"line\">ST.text</span><br><span class=\"line\"><span class=\"keyword\">FROM</span></span><br><span class=\"line\">sys.dm_exec_query_stats QS</span><br><span class=\"line\"><span class=\"comment\">--关键字</span></span><br><span class=\"line\"><span class=\"keyword\">CROSS</span> <span class=\"keyword\">APPLY</span></span><br><span class=\"line\">sys.dm_exec_sql_text(QS.sql_handle) ST</span><br><span class=\"line\"><span class=\"keyword\">WHERE</span></span><br><span class=\"line\">QS.creation_time <span class=\"keyword\">BETWEEN</span> <span class=\"string\">'2018-05-08 09:00:00'</span> <span class=\"keyword\">AND</span> <span class=\"string\">'2018-05-08 18:00:00'</span></span><br><span class=\"line\"><span class=\"keyword\">AND</span> ST.text <span class=\"keyword\">NOT</span> <span class=\"keyword\">LIKE</span> <span class=\"string\">'%SELECT * FROM T_LOCATIONINFO WHERE STRCLIPLOGICID in(%'</span></span><br><span class=\"line\"><span class=\"keyword\">ORDER</span> <span class=\"keyword\">BY</span></span><br><span class=\"line\">QS.creation_time <span class=\"keyword\">DESC</span></span><br></pre></td></tr></table></figure>\n","more":"<h5 id=\"sql执行效率\"><a href=\"#sql执行效率\" class=\"headerlink\" title=\"sql执行效率\"></a>sql执行效率</h5><figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">SELECT</span> TOP <span class=\"number\">50</span> qs.total_worker_time / qs.execution_count <span class=\"keyword\">as</span> [<span class=\"keyword\">Avg</span> CPU <span class=\"built_in\">Time</span>],</span><br><span class=\"line\">    <span class=\"keyword\">SUBSTRING</span>(qt.text, qs.statement_start_offset / <span class=\"number\">2</span>,</span><br><span class=\"line\">              (<span class=\"keyword\">case</span></span><br><span class=\"line\">                   <span class=\"keyword\">when</span> qs.statement_end_offset = <span class=\"number\">-1</span></span><br><span class=\"line\">                       <span class=\"keyword\">then</span> <span class=\"keyword\">len</span>(<span class=\"keyword\">convert</span>(<span class=\"keyword\">nvarchar</span>(<span class=\"keyword\">max</span>), qt.text)) * <span class=\"number\">2</span></span><br><span class=\"line\">                   <span class=\"keyword\">else</span> qs.statement_end_offset <span class=\"keyword\">end</span> - qs.statement_start_offset) / <span class=\"number\">2</span>)</span><br><span class=\"line\">                                                        <span class=\"keyword\">as</span> query_text,</span><br><span class=\"line\">    qt.dbid,</span><br><span class=\"line\">              dbname=db_name(qt.dbid),</span><br><span class=\"line\">    qt.objectid</span><br><span class=\"line\"><span class=\"keyword\">FROM</span> sys.dm_exec_query_stats qs</span><br><span class=\"line\">         <span class=\"keyword\">cross</span> <span class=\"keyword\">apply</span> sys.dm_exec_sql_text(qs.sql_handle) <span class=\"keyword\">as</span> qt</span><br><span class=\"line\"><span class=\"keyword\">ORDER</span> <span class=\"keyword\">BY</span> [<span class=\"keyword\">Avg</span> CPU <span class=\"built_in\">Time</span>] <span class=\"keyword\">DESC</span></span><br></pre></td></tr></table></figure>\n<h5 id=\"SQLServer-查看耗时较多的SQL语句\"><a href=\"#SQLServer-查看耗时较多的SQL语句\" class=\"headerlink\" title=\"SQLServer 查看耗时较多的SQL语句\"></a>SQLServer 查看耗时较多的SQL语句<sunfy-line></h5><figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">SELECT</span> TOP <span class=\"number\">20</span> </span><br><span class=\"line\">    total_worker_time/<span class=\"number\">1000</span> <span class=\"keyword\">AS</span> [总消耗CPU 时间(ms)],execution_count [运行次数],</span><br><span class=\"line\">   qs.total_worker_time/qs.execution_count/<span class=\"number\">1000</span> <span class=\"keyword\">AS</span> [平均消耗CPU 时间(ms)],</span><br><span class=\"line\">    last_execution_time <span class=\"keyword\">AS</span> [最后一次执行时间],</span><br><span class=\"line\">    max_worker_time /<span class=\"number\">1000</span> <span class=\"keyword\">AS</span> [最大执行时间(ms)],</span><br><span class=\"line\">    <span class=\"keyword\">SUBSTRING</span>(qt.text,qs.statement_start_offset/<span class=\"number\">2</span>+<span class=\"number\">1</span>,</span><br><span class=\"line\">        (<span class=\"keyword\">CASE</span> <span class=\"keyword\">WHEN</span> qs.statement_end_offset = <span class=\"number\">-1</span> </span><br><span class=\"line\">            <span class=\"keyword\">THEN</span> <span class=\"keyword\">DATALENGTH</span>(qt.text) </span><br><span class=\"line\">            <span class=\"keyword\">ELSE</span> qs.statement_end_offset <span class=\"keyword\">END</span> -qs.statement_start_offset)/<span class=\"number\">2</span> + <span class=\"number\">1</span>)</span><br><span class=\"line\">        <span class=\"keyword\">AS</span> [使用CPU的语法], qt.text [完整语法],</span><br><span class=\"line\">              dbname=db_name(qt.dbid),</span><br><span class=\"line\">              object_name(qt.objectid,qt.dbid) ObjectName</span><br><span class=\"line\"><span class=\"keyword\">FROM</span> sys.dm_exec_query_stats qs <span class=\"keyword\">WITH</span>(nolock)</span><br><span class=\"line\"><span class=\"keyword\">CROSS</span> <span class=\"keyword\">apply</span> sys.dm_exec_sql_text(qs.sql_handle) <span class=\"keyword\">AS</span> qt</span><br><span class=\"line\"><span class=\"keyword\">WHERE</span> execution_count&gt;<span class=\"number\">1</span></span><br><span class=\"line\"><span class=\"keyword\">ORDER</span> <span class=\"keyword\">BY</span>  total_worker_time <span class=\"keyword\">DESC</span></span><br></pre></td></tr></table></figure>\n<h5 id=\"查询-某个时间段内比较耗时-的SQL\"><a href=\"#查询-某个时间段内比较耗时-的SQL\" class=\"headerlink\" title=\"查询 某个时间段内比较耗时 的SQL\"></a>查询 某个时间段内比较耗时 的SQL</h5><figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">SELECT</span> TOP <span class=\"number\">1000</span> </span><br><span class=\"line\">       ST.text <span class=\"keyword\">AS</span> <span class=\"string\">'执行的SQL语句'</span>,</span><br><span class=\"line\">       QS.execution_count <span class=\"keyword\">AS</span> <span class=\"string\">'执行次数'</span>,</span><br><span class=\"line\">       QS.total_elapsed_time/<span class=\"number\">1000</span> <span class=\"keyword\">AS</span> <span class=\"string\">'耗时'</span>,<span class=\"comment\">--ms</span></span><br><span class=\"line\">       QS.last_worker_time <span class=\"keyword\">AS</span> <span class=\"string\">'12'</span>,</span><br><span class=\"line\">       QS.total_logical_reads <span class=\"keyword\">AS</span> <span class=\"string\">'逻辑读取次数'</span>,</span><br><span class=\"line\">       QS.total_logical_writes <span class=\"keyword\">AS</span> <span class=\"string\">'逻辑写入次数'</span>,</span><br><span class=\"line\">       QS.total_physical_reads <span class=\"keyword\">AS</span> <span class=\"string\">'物理读取次数'</span>,       </span><br><span class=\"line\">       QS.creation_time <span class=\"keyword\">AS</span> <span class=\"string\">'执行时间'</span> ,  </span><br><span class=\"line\">       QS.*</span><br><span class=\"line\"><span class=\"keyword\">FROM</span>   sys.dm_exec_query_stats QS</span><br><span class=\"line\">       <span class=\"keyword\">CROSS</span> <span class=\"keyword\">APPLY</span> </span><br><span class=\"line\">sys.dm_exec_sql_text(QS.sql_handle) ST</span><br><span class=\"line\"><span class=\"keyword\">WHERE</span>  QS.creation_time <span class=\"keyword\">BETWEEN</span> <span class=\"string\">'2017-05-08 12:50:00'</span> <span class=\"keyword\">AND</span> <span class=\"string\">'2017-05-09 17:10:00'</span> </span><br><span class=\"line\"><span class=\"keyword\">ORDER</span> <span class=\"keyword\">BY</span>  QS.total_elapsed_time <span class=\"keyword\">DESC</span></span><br></pre></td></tr></table></figure>\n<h5 id=\"执行最慢的SQL语句（全部sql执行时间列表）\"><a href=\"#执行最慢的SQL语句（全部sql执行时间列表）\" class=\"headerlink\" title=\"执行最慢的SQL语句（全部sql执行时间列表）\"></a>执行最慢的SQL语句（全部sql执行时间列表）</h5><figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">SELECT</span> (total_elapsed_time / execution_count) / <span class=\"number\">1000</span>        N<span class=\"string\">'平均时间ms'</span></span><br><span class=\"line\">     , total_elapsed_time / <span class=\"number\">1000</span>                            N<span class=\"string\">'总花费时间ms'</span></span><br><span class=\"line\">     , total_worker_time / <span class=\"number\">1000</span>                             N<span class=\"string\">'所用的CPU总时间ms'</span></span><br><span class=\"line\">     , total_physical_reads                                 N<span class=\"string\">'物理读取总次数'</span></span><br><span class=\"line\">     , total_logical_reads / execution_count                N<span class=\"string\">'每次逻辑读次数'</span></span><br><span class=\"line\">     , total_logical_reads                                  N<span class=\"string\">'逻辑读取总次数'</span></span><br><span class=\"line\">     , total_logical_writes                                 N<span class=\"string\">'逻辑写入总次数'</span></span><br><span class=\"line\">     , execution_count                                      N<span class=\"string\">'执行次数'</span></span><br><span class=\"line\">     , <span class=\"keyword\">SUBSTRING</span>(st.text, (qs.statement_start_offset / <span class=\"number\">2</span>) + <span class=\"number\">1</span>,</span><br><span class=\"line\">                 ((<span class=\"keyword\">CASE</span> statement_end_offset</span><br><span class=\"line\">                       <span class=\"keyword\">WHEN</span> <span class=\"number\">-1</span> <span class=\"keyword\">THEN</span> <span class=\"keyword\">DATALENGTH</span>(st.text)</span><br><span class=\"line\">                       <span class=\"keyword\">ELSE</span> qs.statement_end_offset <span class=\"keyword\">END</span></span><br><span class=\"line\">                     - qs.statement_start_offset) / <span class=\"number\">2</span>) + <span class=\"number\">1</span>) N<span class=\"string\">'执行语句'</span></span><br><span class=\"line\">     , creation_time                                        N<span class=\"string\">'语句编译时间'</span></span><br><span class=\"line\">     , last_execution_time                                  N<span class=\"string\">'上次执行时间'</span></span><br><span class=\"line\"><span class=\"keyword\">FROM</span> sys.dm_exec_query_stats <span class=\"keyword\">AS</span> qs</span><br><span class=\"line\">         <span class=\"keyword\">CROSS</span> <span class=\"keyword\">APPLY</span> sys.dm_exec_sql_text(qs.sql_handle) st</span><br><span class=\"line\"><span class=\"keyword\">WHERE</span> <span class=\"keyword\">SUBSTRING</span>(st.text, (qs.statement_start_offset / <span class=\"number\">2</span>) + <span class=\"number\">1</span>,</span><br><span class=\"line\">                ((<span class=\"keyword\">CASE</span> statement_end_offset</span><br><span class=\"line\">                      <span class=\"keyword\">WHEN</span> <span class=\"number\">-1</span> <span class=\"keyword\">THEN</span> <span class=\"keyword\">DATALENGTH</span>(st.text)</span><br><span class=\"line\">                      <span class=\"keyword\">ELSE</span> qs.statement_end_offset <span class=\"keyword\">END</span></span><br><span class=\"line\">                    - qs.statement_start_offset) / <span class=\"number\">2</span>) + <span class=\"number\">1</span>) <span class=\"keyword\">not</span> <span class=\"keyword\">like</span> <span class=\"string\">'�tch%'</span></span><br><span class=\"line\"><span class=\"keyword\">ORDER</span> <span class=\"keyword\">BY</span> total_elapsed_time / execution_count <span class=\"keyword\">DESC</span>;</span><br></pre></td></tr></table></figure>\n<h5 id=\"查找逻辑读取最高的查询-存储过程\"><a href=\"#查找逻辑读取最高的查询-存储过程\" class=\"headerlink\" title=\"查找逻辑读取最高的查询(存储过程)\"></a>查找逻辑读取最高的查询(存储过程)</h5><figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">SELECT</span> TOP ( <span class=\"number\">25</span> )</span><br><span class=\"line\">        P.name <span class=\"keyword\">AS</span> [SP <span class=\"keyword\">Name</span>] ,</span><br><span class=\"line\">        Deps.total_logical_reads <span class=\"keyword\">AS</span> [TotalLogicalReads] ,</span><br><span class=\"line\">        deps.total_logical_reads / deps.execution_count <span class=\"keyword\">AS</span> [AvgLogicalReads] ,</span><br><span class=\"line\">        deps.execution_count ,</span><br><span class=\"line\">        <span class=\"keyword\">ISNULL</span>(deps.execution_count / <span class=\"keyword\">DATEDIFF</span>(<span class=\"keyword\">Second</span>, deps.cached_time,</span><br><span class=\"line\">                                               <span class=\"keyword\">GETDATE</span>()), <span class=\"number\">0</span>) <span class=\"keyword\">AS</span> [Calls/<span class=\"keyword\">Second</span>] ,</span><br><span class=\"line\">        deps.total_elapsed_time ,</span><br><span class=\"line\">        deps.total_elapsed_time / deps.execution_count <span class=\"keyword\">AS</span> [avg_elapsed_time] ,</span><br><span class=\"line\">        deps.cached_time</span><br><span class=\"line\"><span class=\"keyword\">FROM</span>    sys.procedures <span class=\"keyword\">AS</span> p</span><br><span class=\"line\">        <span class=\"keyword\">INNER</span> <span class=\"keyword\">JOIN</span> sys.dm_exec_procedure_stats <span class=\"keyword\">AS</span> deps <span class=\"keyword\">ON</span> p.[Object_id] = deps.[Object_id]</span><br><span class=\"line\"><span class=\"keyword\">WHERE</span>   deps.Database_id = DB_ID()</span><br><span class=\"line\"><span class=\"keyword\">ORDER</span> <span class=\"keyword\">BY</span> deps.total_logical_reads <span class=\"keyword\">DESC</span>;</span><br></pre></td></tr></table></figure>\n<h5 id=\"查询CPU最高的10条SQL\"><a href=\"#查询CPU最高的10条SQL\" class=\"headerlink\" title=\"查询CPU最高的10条SQL\"></a>查询CPU最高的10条SQL</h5><figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">SELECT</span> TOP <span class=\"number\">10</span> <span class=\"built_in\">TEXT</span>                                                                                  <span class=\"keyword\">AS</span> <span class=\"string\">'SQL Statement'</span></span><br><span class=\"line\">            , last_execution_time                                                                   <span class=\"keyword\">AS</span> <span class=\"string\">'Last Execution Time'</span></span><br><span class=\"line\">            , (total_logical_reads + total_physical_reads + total_logical_writes) / execution_count <span class=\"keyword\">AS</span> [Average IO]</span><br><span class=\"line\">            , (total_worker_time / execution_count) / <span class=\"number\">1000000.0</span>                                     <span class=\"keyword\">AS</span> [Average CPU <span class=\"built_in\">Time</span> (sec)]</span><br><span class=\"line\">            , (total_elapsed_time / execution_count) / <span class=\"number\">1000000.0</span>                                    <span class=\"keyword\">AS</span> [Average Elapsed <span class=\"built_in\">Time</span> (sec)]</span><br><span class=\"line\">            , execution_count                                                                       <span class=\"keyword\">AS</span> <span class=\"string\">\"Execution Count\"</span></span><br><span class=\"line\">            , qs.total_physical_reads</span><br><span class=\"line\">            , qs.total_logical_writes</span><br><span class=\"line\">            , qp.query_plan                                                                         <span class=\"keyword\">AS</span> <span class=\"string\">\"Query Plan\"</span></span><br><span class=\"line\"><span class=\"keyword\">FROM</span> sys.dm_exec_query_stats qs</span><br><span class=\"line\">         <span class=\"keyword\">CROSS</span> <span class=\"keyword\">APPLY</span> sys.dm_exec_sql_text(qs.plan_handle) st</span><br><span class=\"line\">         <span class=\"keyword\">CROSS</span> <span class=\"keyword\">APPLY</span> sys.dm_exec_query_plan(qs.plan_handle) qp</span><br><span class=\"line\"><span class=\"keyword\">ORDER</span> <span class=\"keyword\">BY</span> total_elapsed_time / execution_count <span class=\"keyword\">DESC</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">-------------------------方式二：有中文列名称-------------------------------------</span></span><br><span class=\"line\"><span class=\"keyword\">SELECT</span> TOP <span class=\"number\">20</span></span><br><span class=\"line\">    total_worker_time/<span class=\"number\">1000</span> <span class=\"keyword\">AS</span> [总消耗CPU 时间(ms)],execution_count [运行次数],</span><br><span class=\"line\">    qs.total_worker_time/qs.execution_count/<span class=\"number\">1000</span> <span class=\"keyword\">AS</span> [平均消耗CPU 时间(ms)],</span><br><span class=\"line\">    last_execution_time <span class=\"keyword\">AS</span> [最后一次执行时间],max_worker_time /<span class=\"number\">1000</span> <span class=\"keyword\">AS</span> [最大执行时间(ms)],</span><br><span class=\"line\">    <span class=\"keyword\">SUBSTRING</span>(qt.text,qs.statement_start_offset/<span class=\"number\">2</span>+<span class=\"number\">1</span>,</span><br><span class=\"line\">        (<span class=\"keyword\">CASE</span> <span class=\"keyword\">WHEN</span> qs.statement_end_offset = <span class=\"number\">-1</span></span><br><span class=\"line\">        <span class=\"keyword\">THEN</span> <span class=\"keyword\">DATALENGTH</span>(qt.text)</span><br><span class=\"line\">        <span class=\"keyword\">ELSE</span> qs.statement_end_offset <span class=\"keyword\">END</span> -qs.statement_start_offset)/<span class=\"number\">2</span> + <span class=\"number\">1</span>)</span><br><span class=\"line\">    <span class=\"keyword\">AS</span> [使用CPU的语法], qt.text [完整语法],</span><br><span class=\"line\">    qt.dbid, dbname=db_name(qt.dbid),</span><br><span class=\"line\">    qt.objectid,object_name(qt.objectid,qt.dbid) ObjectName</span><br><span class=\"line\"><span class=\"keyword\">FROM</span> sys.dm_exec_query_stats qs <span class=\"keyword\">WITH</span>(nolock)</span><br><span class=\"line\"><span class=\"keyword\">CROSS</span> <span class=\"keyword\">apply</span> sys.dm_exec_sql_text(qs.sql_handle) <span class=\"keyword\">AS</span> qt</span><br><span class=\"line\"><span class=\"keyword\">WHERE</span> execution_count&gt;<span class=\"number\">1</span></span><br><span class=\"line\"><span class=\"keyword\">ORDER</span> <span class=\"keyword\">BY</span>  total_worker_time <span class=\"keyword\">DESC</span></span><br></pre></td></tr></table></figure>\n<h5 id=\"找出执行频繁的语句的SQL语句\"><a href=\"#找出执行频繁的语句的SQL语句\" class=\"headerlink\" title=\"找出执行频繁的语句的SQL语句\"></a>找出执行频繁的语句的SQL语句</h5><figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">with</span> aa <span class=\"keyword\">as</span> (</span><br><span class=\"line\">    <span class=\"keyword\">SELECT</span></span><br><span class=\"line\"><span class=\"comment\">--执行次数 </span></span><br><span class=\"line\">QS.execution_count,</span><br><span class=\"line\"><span class=\"comment\">--查询语句 </span></span><br><span class=\"line\"><span class=\"keyword\">SUBSTRING</span>(ST.text, (QS.statement_start_offset / <span class=\"number\">2</span>) + <span class=\"number\">1</span>,</span><br><span class=\"line\">          ((<span class=\"keyword\">CASE</span> QS.statement_end_offset</span><br><span class=\"line\">                <span class=\"keyword\">WHEN</span> <span class=\"number\">-1</span> <span class=\"keyword\">THEN</span> <span class=\"keyword\">DATALENGTH</span>(st.text)</span><br><span class=\"line\">                <span class=\"keyword\">ELSE</span> QS.statement_end_offset <span class=\"keyword\">END</span> - QS.statement_start_offset) / <span class=\"number\">2</span>) + <span class=\"number\">1</span></span><br><span class=\"line\">    ) <span class=\"keyword\">AS</span> statement_text,</span><br><span class=\"line\"><span class=\"comment\">--执行文本 </span></span><br><span class=\"line\">ST.text,</span><br><span class=\"line\"><span class=\"comment\">--执行计划 </span></span><br><span class=\"line\">qs.last_elapsed_time,</span><br><span class=\"line\">qs.min_elapsed_time,</span><br><span class=\"line\">qs.max_elapsed_time,</span><br><span class=\"line\">QS.total_worker_time,</span><br><span class=\"line\">QS.last_worker_time,</span><br><span class=\"line\">QS.max_worker_time,</span><br><span class=\"line\">QS.min_worker_time</span><br><span class=\"line\">    <span class=\"keyword\">FROM</span> sys.dm_exec_query_stats QS</span><br><span class=\"line\"><span class=\"comment\">--关键字 </span></span><br><span class=\"line\">             <span class=\"keyword\">CROSS</span> <span class=\"keyword\">APPLY</span></span><br><span class=\"line\">         sys.dm_exec_sql_text(QS.sql_handle) ST</span><br><span class=\"line\">    <span class=\"keyword\">WHERE</span> QS.last_execution_time &gt; <span class=\"string\">'2016-02-14 00:00:00'</span></span><br><span class=\"line\">      <span class=\"keyword\">and</span> execution_count &gt; <span class=\"number\">500</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">-- AND ST.text LIKE '%%' </span></span><br><span class=\"line\"><span class=\"comment\">--ORDER BY </span></span><br><span class=\"line\"><span class=\"comment\">--QS.execution_count DESC</span></span><br><span class=\"line\"></span><br><span class=\"line\">)</span><br><span class=\"line\"><span class=\"keyword\">select</span> <span class=\"built_in\">text</span>,</span><br><span class=\"line\">       <span class=\"keyword\">max</span>(execution_count) execution_count <span class=\"comment\">--,last_elapsed_time,min_elapsed_time,max_elapsed_time </span></span><br><span class=\"line\"><span class=\"keyword\">from</span> aa</span><br><span class=\"line\"><span class=\"keyword\">where</span> [<span class=\"built_in\">text</span>] <span class=\"keyword\">not</span> <span class=\"keyword\">like</span> <span class=\"string\">'%sp_MSupd_%'</span></span><br><span class=\"line\">  <span class=\"keyword\">and</span> [<span class=\"built_in\">text</span>] <span class=\"keyword\">not</span> <span class=\"keyword\">like</span> <span class=\"string\">'%sp_MSins_%'</span></span><br><span class=\"line\">  <span class=\"keyword\">and</span> [<span class=\"built_in\">text</span>] <span class=\"keyword\">not</span> <span class=\"keyword\">like</span> <span class=\"string\">'%sp_MSdel_%'</span></span><br><span class=\"line\"><span class=\"keyword\">group</span> <span class=\"keyword\">by</span> <span class=\"built_in\">text</span></span><br><span class=\"line\"><span class=\"keyword\">order</span> <span class=\"keyword\">by</span> <span class=\"number\">2</span> <span class=\"keyword\">desc</span></span><br></pre></td></tr></table></figure>\n<h5 id=\"查询当前锁定的表-锁等待\"><a href=\"#查询当前锁定的表-锁等待\" class=\"headerlink\" title=\"查询当前锁定的表(锁等待)\"></a>查询当前锁定的表(锁等待)</h5><figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">select</span> request_session_id spid, OBJECT_NAME(resource_associated_entity_id) tableName</span><br><span class=\"line\"><span class=\"keyword\">from</span> sys.dm_tran_locks</span><br><span class=\"line\"><span class=\"keyword\">where</span> resource_type = <span class=\"string\">'OBJECT'</span></span><br></pre></td></tr></table></figure>\n<h5 id=\"查询到锁表后进行杀死\"><a href=\"#查询到锁表后进行杀死\" class=\"headerlink\" title=\"查询到锁表后进行杀死\"></a>查询到锁表后进行杀死</h5><figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">declare</span></span><br><span class=\"line\">    @spid <span class=\"built_in\">int</span></span><br><span class=\"line\"><span class=\"keyword\">Set</span> @spid = <span class=\"number\">51</span> <span class=\"comment\">--锁表进程</span></span><br><span class=\"line\"><span class=\"keyword\">declare</span></span><br><span class=\"line\">    @<span class=\"keyword\">sql</span> <span class=\"built_in\">varchar</span>(<span class=\"number\">1000</span>)</span><br><span class=\"line\"><span class=\"keyword\">set</span> @<span class=\"keyword\">sql</span> = <span class=\"string\">'kill '</span> + <span class=\"keyword\">cast</span>(@spid <span class=\"keyword\">as</span> <span class=\"built_in\">varchar</span>)</span><br><span class=\"line\">exec (@<span class=\"keyword\">sql</span>)</span><br></pre></td></tr></table></figure>\n<h5 id=\"查询SqlServer总体的内存使用情况\"><a href=\"#查询SqlServer总体的内存使用情况\" class=\"headerlink\" title=\"查询SqlServer总体的内存使用情况\"></a>查询SqlServer总体的内存使用情况</h5><figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">-- 查询SqlServer总体的内存使用情况</span></span><br><span class=\"line\"><span class=\"keyword\">select</span>      <span class=\"keyword\">type</span></span><br><span class=\"line\">        , <span class=\"keyword\">sum</span>(virtual_memory_reserved_kb) VM_Reserved</span><br><span class=\"line\">        , <span class=\"keyword\">sum</span>(virtual_memory_committed_kb) VM_Commited</span><br><span class=\"line\">        , <span class=\"keyword\">sum</span>(awe_allocated_kb) AWE_Allocated</span><br><span class=\"line\">        , <span class=\"keyword\">sum</span>(shared_memory_reserved_kb) Shared_Reserved</span><br><span class=\"line\">        , <span class=\"keyword\">sum</span>(shared_memory_committed_kb) Shared_Commited</span><br><span class=\"line\">        <span class=\"comment\">--, sum(single_pages_kb)    --SQL2005、2008</span></span><br><span class=\"line\">        <span class=\"comment\">--, sum(multi_pages_kb)        --SQL2005、2008</span></span><br><span class=\"line\"><span class=\"keyword\">from</span>    sys.dm_os_memory_clerks</span><br><span class=\"line\"><span class=\"keyword\">group</span> <span class=\"keyword\">by</span> <span class=\"keyword\">type</span></span><br><span class=\"line\"><span class=\"keyword\">order</span> <span class=\"keyword\">by</span> <span class=\"keyword\">type</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">-- 查询当前数据库缓存的所有数据页面，哪些数据表，缓存的数据页面数量</span></span><br><span class=\"line\"><span class=\"comment\">-- 从这些信息可以看出，系统经常要访问的都是哪些表，有多大？</span></span><br><span class=\"line\"><span class=\"keyword\">select</span> p.object_id, object_name=object_name(p.object_id), p.index_id, buffer_pages=<span class=\"keyword\">count</span>(*) </span><br><span class=\"line\"><span class=\"keyword\">from</span> sys.allocation_units a, </span><br><span class=\"line\">    sys.dm_os_buffer_descriptors b, </span><br><span class=\"line\">    sys.partitions p </span><br><span class=\"line\"><span class=\"keyword\">where</span> a.allocation_unit_id=b.allocation_unit_id </span><br><span class=\"line\">    <span class=\"keyword\">and</span> a.container_id=p.hobt_id </span><br><span class=\"line\">    <span class=\"keyword\">and</span> b.database_id=db_id()</span><br><span class=\"line\"><span class=\"keyword\">group</span> <span class=\"keyword\">by</span> p.object_id,p.index_id </span><br><span class=\"line\"><span class=\"keyword\">order</span> <span class=\"keyword\">by</span> buffer_pages <span class=\"keyword\">desc</span> </span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">-- 查询缓存的各类执行计划，及分别占了多少内存</span></span><br><span class=\"line\"><span class=\"comment\">-- 可以对比动态查询与参数化SQL（预定义语句）的缓存量</span></span><br><span class=\"line\"><span class=\"keyword\">select</span>    cacheobjtype</span><br><span class=\"line\">        , objtype</span><br><span class=\"line\">        , <span class=\"keyword\">sum</span>(<span class=\"keyword\">cast</span>(size_in_bytes <span class=\"keyword\">as</span> <span class=\"built_in\">bigint</span>))/<span class=\"number\">1024</span> <span class=\"keyword\">as</span> size_in_kb</span><br><span class=\"line\">        , <span class=\"keyword\">count</span>(bucketid) <span class=\"keyword\">as</span> cache_count</span><br><span class=\"line\"><span class=\"keyword\">from</span>    sys.dm_exec_cached_plans</span><br><span class=\"line\"><span class=\"keyword\">group</span> <span class=\"keyword\">by</span> cacheobjtype, objtype</span><br><span class=\"line\"><span class=\"keyword\">order</span> <span class=\"keyword\">by</span> cacheobjtype, objtype</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">-- 查询缓存中具体的执行计划，及对应的SQL</span></span><br><span class=\"line\"><span class=\"comment\">-- 将此结果按照数据表或SQL进行统计，可以作为基线，调整索引时考虑</span></span><br><span class=\"line\"><span class=\"comment\">-- 查询结果会很大，注意将结果集输出到表或文件中</span></span><br><span class=\"line\"><span class=\"keyword\">SELECT</span>  usecounts ,</span><br><span class=\"line\">        refcounts ,</span><br><span class=\"line\">        size_in_bytes ,</span><br><span class=\"line\">        cacheobjtype ,</span><br><span class=\"line\">        objtype ,</span><br><span class=\"line\">        <span class=\"built_in\">TEXT</span></span><br><span class=\"line\"><span class=\"keyword\">FROM</span>    sys.dm_exec_cached_plans cp</span><br><span class=\"line\">        <span class=\"keyword\">CROSS</span> <span class=\"keyword\">APPLY</span> sys.dm_exec_sql_text(plan_handle)</span><br><span class=\"line\"><span class=\"keyword\">ORDER</span> <span class=\"keyword\">BY</span> objtype <span class=\"keyword\">DESC</span> ;</span><br><span class=\"line\">GO</span><br></pre></td></tr></table></figure>\n<h5 id=\"使用SQL语句设置SQLserver内存分配\"><a href=\"#使用SQL语句设置SQLserver内存分配\" class=\"headerlink\" title=\"使用SQL语句设置SQLserver内存分配\"></a>使用SQL语句设置SQLserver内存分配</h5><figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">-- 1.使用SQL语句设置SQLserver内存分配：</span></span><br><span class=\"line\"><span class=\"comment\">-- a.配置最小内存</span></span><br><span class=\"line\"><span class=\"comment\">--将最小内存设置为0MB</span></span><br><span class=\"line\">exec sp_configure N'min server memory (MB) ',16</span><br><span class=\"line\"><span class=\"comment\">--b.配置最大内存</span></span><br><span class=\"line\"><span class=\"comment\">--将最大内存设置为256MB</span></span><br><span class=\"line\">exec sp_configure N'max server memory (MB)',266 </span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">--执行结果：</span></span><br><span class=\"line\"><span class=\"comment\">--配置选项 'min server memory (MB)' 已从 14 更改为 16。请运行 RECONFIGURE 语句进行安装。</span></span><br><span class=\"line\"><span class=\"comment\">--配置选项 'max server memory (MB)' 已从 444 更改为 266。请运行 RECONFIGURE 语句进行安装。</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">--最后执行下面语句进行安装</span></span><br><span class=\"line\">reconfigure <span class=\"keyword\">with</span> override</span><br><span class=\"line\"><span class=\"comment\">--执行结果：</span></span><br><span class=\"line\">命令已成功完成。</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">--系统服务日志：</span></span><br><span class=\"line\">配置选项 <span class=\"string\">'min server memory (MB)'</span> 已从 <span class=\"number\">14</span> 更改为 <span class=\"number\">16</span>。请运行 RECONFIGURE 语句进行安装。</span><br><span class=\"line\">配置选项 <span class=\"string\">'max server memory (MB)'</span> 已从 <span class=\"number\">444</span> 更改为 <span class=\"number\">266</span>。请运行 RECONFIGURE 语句进行安装。</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">--2.手动操作设置</span></span><br><span class=\"line\"><span class=\"comment\">--右击本地服务器--&gt;服务器属性--&gt;内存 设置完，单击确定即可。</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">一般设置完后，最好将该<span class=\"keyword\">SQL</span>服务重启下。</span><br></pre></td></tr></table></figure>\n<h5 id=\"查询SQLSERVER执行过的SQL记录\"><a href=\"#查询SQLSERVER执行过的SQL记录\" class=\"headerlink\" title=\"查询SQLSERVER执行过的SQL记录\"></a>查询SQLSERVER执行过的SQL记录</h5><figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">仅支持SQL SERVER2008及以上版本</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">SELECT</span> TOP <span class=\"number\">1000</span></span><br><span class=\"line\"><span class=\"comment\">--创建时间</span></span><br><span class=\"line\">QS.creation_time,</span><br><span class=\"line\"><span class=\"comment\">--查询语句</span></span><br><span class=\"line\"><span class=\"keyword\">SUBSTRING</span>(ST.text,(QS.statement_start_offset/<span class=\"number\">2</span>)+<span class=\"number\">1</span>,</span><br><span class=\"line\">((<span class=\"keyword\">CASE</span> QS.statement_end_offset <span class=\"keyword\">WHEN</span> <span class=\"number\">-1</span> <span class=\"keyword\">THEN</span> <span class=\"keyword\">DATALENGTH</span>(st.text)</span><br><span class=\"line\"><span class=\"keyword\">ELSE</span> QS.statement_end_offset <span class=\"keyword\">END</span> - QS.statement_start_offset)/<span class=\"number\">2</span>) + <span class=\"number\">1</span></span><br><span class=\"line\">) <span class=\"keyword\">AS</span> statement_text,</span><br><span class=\"line\"><span class=\"comment\">--执行文本</span></span><br><span class=\"line\">ST.text,</span><br><span class=\"line\"><span class=\"comment\">--执行计划</span></span><br><span class=\"line\">QS.total_worker_time,</span><br><span class=\"line\">QS.last_worker_time,</span><br><span class=\"line\">QS.max_worker_time,</span><br><span class=\"line\">QS.min_worker_time</span><br><span class=\"line\"><span class=\"keyword\">FROM</span></span><br><span class=\"line\">sys.dm_exec_query_stats QS</span><br><span class=\"line\"><span class=\"comment\">--关键字</span></span><br><span class=\"line\"><span class=\"keyword\">CROSS</span> <span class=\"keyword\">APPLY</span></span><br><span class=\"line\">sys.dm_exec_sql_text(QS.sql_handle) ST</span><br><span class=\"line\"><span class=\"keyword\">WHERE</span></span><br><span class=\"line\">QS.creation_time <span class=\"keyword\">BETWEEN</span> <span class=\"string\">'2018-05-08 09:00:00'</span> <span class=\"keyword\">AND</span> <span class=\"string\">'2018-05-08 18:00:00'</span></span><br><span class=\"line\">–<span class=\"keyword\">AND</span> ST.text <span class=\"keyword\">LIKE</span> <span class=\"string\">'%%'</span></span><br><span class=\"line\"><span class=\"keyword\">ORDER</span> <span class=\"keyword\">BY</span></span><br><span class=\"line\">QS.creation_time <span class=\"keyword\">DESC</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">SELECT</span> TOP <span class=\"number\">1000</span></span><br><span class=\"line\"><span class=\"comment\">--创建时间</span></span><br><span class=\"line\">QS.creation_time,</span><br><span class=\"line\"><span class=\"comment\">--执行文本</span></span><br><span class=\"line\">ST.text</span><br><span class=\"line\"><span class=\"keyword\">FROM</span></span><br><span class=\"line\">sys.dm_exec_query_stats QS</span><br><span class=\"line\"><span class=\"comment\">--关键字</span></span><br><span class=\"line\"><span class=\"keyword\">CROSS</span> <span class=\"keyword\">APPLY</span></span><br><span class=\"line\">sys.dm_exec_sql_text(QS.sql_handle) ST</span><br><span class=\"line\"><span class=\"keyword\">WHERE</span></span><br><span class=\"line\">QS.creation_time <span class=\"keyword\">BETWEEN</span> <span class=\"string\">'2018-05-08 09:00:00'</span> <span class=\"keyword\">AND</span> <span class=\"string\">'2018-05-08 18:00:00'</span></span><br><span class=\"line\"><span class=\"keyword\">AND</span> ST.text <span class=\"keyword\">NOT</span> <span class=\"keyword\">LIKE</span> <span class=\"string\">'%SELECT * FROM T_LOCATIONINFO WHERE STRCLIPLOGICID in(%'</span></span><br><span class=\"line\"><span class=\"keyword\">ORDER</span> <span class=\"keyword\">BY</span></span><br><span class=\"line\">QS.creation_time <span class=\"keyword\">DESC</span></span><br></pre></td></tr></table></figure>\n","next":{"title":"MySQL管理员用户设置和修改密码的方法","path":"api/articles/resource-DB-MySQL-MySQL管理员用户设置和修改密码的方法.json","image":"/img/header_img/DB/edit.png","num_read":724,"num_like":230,"num_collection":327,"num_comments":129},"prev":{"title":"SQLSERVER数据库触发器","path":"api/articles/resource-DB-SQLServer-触发器.json","image":"/img/header_img/DB/Databasetrigger.png","num_read":495,"num_like":492,"num_collection":150,"num_comments":122},"categories":[{"name":"数据库","path":"api/categories/数据库.json","pathContent":"api/categories/数据库","description":"结构化存储格式+事务和并发控制+内存管理+SQL访问接口","cover":"https://sunfy9.gitee.io/project/photo/project/db.jpg"}],"tags":[{"name":"sqlServer","path":"api/tags/sqlServer.json","pathContent":"api/tags/sqlServer","description":"[sqlServer]暂未设置说明","cover":"https://sunfy9.gitee.io/img/header_img/sunfy-default.png"}]}